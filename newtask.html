<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Información de dispositivo - KYROS</title>
    <link rel="icon" href="images/logo.ico" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand me-auto" href="index.html">
                <img src="images/logo.png" height="40px" alt="KYROS logo">
                <h3 class="logoH">KYROS</h3>
            </a>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">KYROS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-center flex-grow-1 pe-3">
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" aria-current="page" href="index.html">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="rooms.html">Habitaciones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="security.html">Seguridad</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2 active" href="automatize.html">Automatización</a>
                        </li>
                    </ul>
                </div>
            </div>
            <a href="login.html" class="login-button">Iniciar sesión</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
    <!-- End navbar -->

    <!-- Content -->
    <div class="container" id="main-container-addtask">
        <div class="row">
            <!-- Breadcrumb -->
            <nav class="d-flex">
            <h6 class="mb-0" id="breadcrumb">
                <a href="index.html" class="text-reset">Inicio</a>
                <span>></span>
                <a href="automatize.html" class="text-reset">Automatización</a>
                <span>></span>
                <a href="#" class="text-reset">Agregar tarea</a>
            </h6>
            </nav>
            <!-- Breadcrumb -->
        </div>
        <div class="row">
            <h1 class="heading">Agregar tarea</h1>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="row name" id="name">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <h3>Nombre de tarea</h3>
                        <input type="text" id="user-input" name="taskName">
                        <br>
                        <button class="mt-2" id="task-button" onclick="nameClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Post It .png" alt="Image">
                </div>
            </div>
            <div class="row dev" id="dev" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <h3>Nombre de dispositivo</h3>
                        <div class="dropdown">
                            <button
                                class="btn btn-primary dropdown-toggle"
                                data-bs-toggle="dropdown"
                                type="button"
                                id="dropdownMenuButton"
                                data-mdb-dropdown-init
                                data-mdb-ripple-init
                                aria-expanded="false"
                            >
                            </button>
                            <ul class="dropdown-menu w-100" id="tableMenu" aria-labelledby="dropdownMenuButton">
                                <li><a class="dropdown-item" href="#">Foco 1</a></li>
                                <!-- TODO : Esto se debe hacer dinámico con todos los dispositivos que tiene el user -->
                            </ul>
                        </div>
                        <br>
                        <button id="task-button" onclick="devClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/SEO.png" alt="Image">
                </div>
            </div>

            <div class="row start-fan" id="start-fan" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-fan">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOptionButton"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="optionMenu" aria-labelledby="dropdownOptionButton">
                                    <li><a class="dropdown-item option" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option" href="#">Encender a una temperatura establecida</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOn" style="display: none !important;">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTime"
                                min="00:00"
                                max="24:00"
                            />
                        </div>
                        <br>
                        <div class="d-flex" id="tempOn" style="display: none !important;">
                            <h3>Encender cuando llegue a</h3>
                            <input type="number" id="turnOnTemp">
                            <h3 class="degree">°C</h3>
                        </div>
                        <br>
                        <button id="task-button" onclick="startFanClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>
            <div class="row stop-fan" id="stop-fan" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-fan-off">
                            <h3>Opciones para apagar</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption2Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option2Menu" aria-labelledby="dropdownOption2Button">
                                    <li><a class="dropdown-item option2" href="#">Apagar a una hora establecida</a></li>
                                    <li><a class="dropdown-item option2" href="#">Apagar a una temperatura establecida</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOff" style="display: none !important;">
                            <h3>Apagar a la(s)</h3>
                            <input
                            type="time"
                            id="turnOffTime"
                            min="00:00"
                            max="24:00"
                            required />
                        </div>
                        <br>
                        <div class="d-flex" id="tempOff" style="display: none !important;">
                            <h3>Apagar a cuando llegue a</h3>
                            <input type="number" id="turnOffTemp">
                            <h3 class="degree">°C</h3>
                        </div>
                        <br>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row start-light" id="start-light" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-light-on">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption3Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option3Menu" aria-labelledby="dropdownOption3Button">
                                    <li><a class="dropdown-item option3" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option3" href="#">Encender cuando no hay luz</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOnLight" style="display: none !important;">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTimeLight"
                                min="00:00"
                                max="24:00"
                                required 
                            />
                        </div>
                        <br>
                        <button id="task-button" onclick="startLightClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>
            <div class="row stop-light" id="stop-light" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-light-off">
                            <h3>Opciones para apagar</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption4Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option4Menu" aria-labelledby="dropdownOption4Button">
                                    <li><a class="dropdown-item option4" href="#">Apagar a una hora establecida</a></li>
                                    <li><a class="dropdown-item option4" href="#">Apagar cuando hay luz</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOffLight" style="display: none !important;">
                            <h3>Apagar a la(s)</h3>
                            <input
                                type="time"
                                id="turnOffTimeLight"
                                min="00:00"
                                max="24:00"
                                required 
                            />
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row alarm" id="alarm" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div class="d-flex" id="turnOnAlarm">
                            <h3>Sonar a la(s)</h3>
                            <input
                                type="time"
                                id="turnOn"
                                min="00:00"
                                max="24:00"
                                required 
                            />
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="col-lg-5 mt-3" id="btn-div" style="display: none;">
                <button id="task-button">Guardar</button>
            </div>
        </div>
    </div>
    <!-- End content -->

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <img src="images/logo.png" alt="KYROS logo" height="40px">
                        <h3 class="logo-h3">KYROS</h3>
                        <p>Manten el control sobre tu hogar</p>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Soporte</h2>
                        <ul>
                            <li><a href="helpcenter.html">Centro de ayuda</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Contáctenos</h2>
                        <p>687-123-4567</p>
                        <p>test@outlook.com</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <h3 class="copyright">&copy;2025 Instituto Tecnológico Superior de Guasave</h3>
            </div>
        </div>

    </footer>
    <!-- End footer -->

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="js/auth.js"></script>
    <script src="js/navbar.js"></script>

    <!-- SweetAlert Javascript -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!-- Frontend JavaScript -->
    <script>
        // Dropdown de nombres de dispositivos
        const dropdownItems = document.querySelectorAll('#tableMenu .dropdown-item');

        dropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownMenuButton');
                dropdownButton.textContent = item.textContent;
            });
        });
    
        // Dropdown para opciones de encender abanico
        const dropdownOption = document.querySelectorAll('#optionMenu .option');

        dropdownOption.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOptionButton');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOn");
                let temp = document.getElementById("tempOn");
                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                    temp.classList.remove('d-flex');
                    temp.style.display="none";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    temp.classList.add('d-flex');
                    temp.style.display="flex";
                }
            });
        });

        // Asegurar que solo 1 input de encender abanico tenga un valor
        document.getElementById("turnOnTime").addEventListener('input', () => {
            document.getElementById("turnOnTemp").value = "";
        });

        document.getElementById("turnOnTemp").addEventListener('input', () => {
            document.getElementById("turnOnTime").value = "";
        });
    
        // Dropdown de opciones para apagar abanico
        const dropdownOption2 = document.querySelectorAll('#option2Menu .option2');

        dropdownOption2.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption2Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOff");
                let temp = document.getElementById("tempOff");
                if(dropdownButton.innerText === "Apagar a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                    temp.classList.remove('d-flex');
                    temp.style.display="none";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    temp.classList.add('d-flex');
                    temp.style.display="flex";
                }
            });
        });
        
        // Asegurar que solo 1 input para apagar abanico tenga un valor
        document.getElementById("turnOffTime").addEventListener('input', () => {
            document.getElementById("turnOffTemp").value = "";
        });

        document.getElementById("turnOffTemp").addEventListener('input', () => {
            document.getElementById("turnOffTime").value = "";
        });
    
        // Dropdown de opciones para encender foco
        const dropdownOption3 = document.querySelectorAll('#option3Menu .option3');

        dropdownOption3.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption3Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOnLight");
                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                }
            });
        });
    
        // Dropdown de opciones para apagar foco
        const dropdownOption4 = document.querySelectorAll('#option4Menu .option4');

        dropdownOption4.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption4Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOffLight");
                if(dropdownButton.innerText === "Apagar a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                }
            });
        });

        function nameClick(){
            let n = document.getElementById("user-input").value;
            if(n.trim()!==""){
                let ndiv = document.getElementById("name");
                let ddiv = document.getElementById("dev");

                ndiv.style.display = "none";
                ddiv.style.display = "flex";
                ddiv.classList.add('swing-in-bottom-bck');
            } else {
                swal("Campo vacío", "Favor de ingresar un nombre", "warning");
            }
        }

        function devClick(){
            let n = document.getElementById("dropdownMenuButton").textContent;
            if(n.trim()!==""){
                let ddiv = document.getElementById("dev");
                ddiv.style.display = "none";
                // TODO : somehow check what device type this is
                let f = document.getElementById("start-fan");
                f.style.display = "flex";
                f.classList.add('swing-in-bottom-bck');
            } else {
                swal("Campo vacío", "Favor de seleccionar un dispositivo", "warning");
            }
        }

        function startFanClick(){
            let time = document.getElementById("turnOnTime").value;
            let temp = document.getElementById("turnOnTemp").value;
            if((time.trim()!=="" && temp.trim()==="") || (temp.trim()!=="" && time.trim()==="")){
                let startdiv = document.getElementById("start-fan");
                let stopdiv = document.getElementById("stop-fan");
                let save = document.getElementById("btn-div");

                startdiv.style.display = "none";
                stopdiv.style.display = "flex";
                save.style.display = "flex"
                stopdiv.classList.add('swing-in-bottom-bck');
                save.classList.add('swing-in-bottom-bck');
            } else{
                swal("Campos vacíos", "Favor de seleccionar e ingresar una opción", "warning");
            }
        }

        function startLightClick(){
            let time = document.getElementById("turnOnTimeLight").value;
            let noLight = document.getElementById("dropdownOption3Button").textContent;
            if((time.trim()!=="") || (noLight==="Encender cuando no hay luz")){
                let startdiv = document.getElementById("start-light");
                let stopdiv = document.getElementById("stop-light");
                let save = document.getElementById("btn-div");

                startdiv.style.display = "none";
                stopdiv.style.display = "flex";
                save.style.display = "flex"
                stopdiv.classList.add('swing-in-bottom-bck');
                save.classList.add('swing-in-bottom-bck');
            } else{
                swal("Campos vacíos", "Favor de seleccionar una opción", "warning");
            }
        }
    </script>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let selectedDeviceId = null;
        let selectedDeviceType = null;

        // Función para mostrar el formulario correcto según el tipo de dispositivo
        function showFormForDeviceType(tipo) {
            const lightDiv = document.querySelector('.light');
            const fanDiv = document.querySelector('.fan');
            const alarmDiv = document.querySelector('.alarm');
            const actuadorDiv = document.querySelector('.actuador');

            // Ocultar todos
            lightDiv.style.display = 'none';
            fanDiv.style.display = 'none';
            alarmDiv.style.display = 'none';
            actuadorDiv.style.display = 'none';

            // Mostrar el correcto según el tipo
            if (tipo === 'luz') {
                lightDiv.style.display = 'block';
            } else if (tipo === 'temperatura') {
                fanDiv.style.display = 'block';
            } else if (tipo === 'actuador') {
                actuadorDiv.style.display = 'block';
            } else {
                // Por defecto, mostrar luz
                lightDiv.style.display = 'block';
            }
        }

        // Cargar dispositivos del usuario
        async function loadDevices() {
            try {
                const response = await fetchWithAuth(`${API_URL}/devices`);
                const data = await response.json();

                if (data.success) {
                    const dropdown = document.getElementById('tableMenu');
                    const dropdownButton = document.getElementById('dropdownMenuButton');

                    dropdown.innerHTML = '';

                    if (data.data.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay dispositivos</a></li>';
                        dropdownButton.textContent = 'Sin dispositivos';
                        return;
                    }

                    // Mostrar todos los dispositivos
                    data.data.forEach(device => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item';
                        a.href = '#';
                        a.textContent = `${device.nombre} (${device.tipo})`;
                        a.onclick = () => {
                            selectedDeviceId = device._id;
                            selectedDeviceType = device.tipo;
                            dropdownButton.textContent = device.nombre;
                            showFormForDeviceType(device.tipo);
                        };
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });

                    // Pre-seleccionar el primero
                    if (data.data.length > 0) {
                        selectedDeviceId = data.data[0]._id;
                        selectedDeviceType = data.data[0].tipo;
                        dropdownButton.textContent = data.data[0].nombre;
                        showFormForDeviceType(data.data[0].tipo);
                    }
                }
            } catch (error) {
                console.error('Error al cargar dispositivos:', error);
                swal("Error", "Error al cargar los dispositivos", "error");
            }
        }

        // Guardar automatización
        const saveButton = document.querySelector('.task-button');
        const taskNameInput = document.querySelector('input[name="taskName"]');

        saveButton.addEventListener('click', async (e) => {
            e.preventDefault();

            const taskName = taskNameInput.value.trim();

            if (!taskName) {
                alert('Por favor ingrese el nombre de la tarea');
                return;
            }

            if (!selectedDeviceId) {
                alert('Por favor seleccione un dispositivo');
                return;
            }

            try {
                const taskData = {
                    nombre: taskName,
                    descripcion: '',
                    activa: true,
                    trigger: {
                        tipo: 'horario'
                    },
                    acciones: [{
                        dispositivo: selectedDeviceId,
                        accion: 'encender',
                        parametros: {},
                        orden: 0
                    }]
                };

                // Obtener datos según el tipo de dispositivo
                const lightDiv = document.querySelector('.light');
                const fanDiv = document.querySelector('.fan');
                const alarmDiv = document.querySelector('.alarm');
                const actuadorDiv = document.querySelector('.actuador');

                if (actuadorDiv && actuadorDiv.style.display !== 'none') {
                    const turnOnTime = document.getElementById('turnOnTimeActuador').value;
                    const turnOffTime = document.getElementById('turnOffTimeActuador').value;

                    if (turnOnTime) {
                        taskData.trigger.horario = {
                            dias: [0, 1, 2, 3, 4, 5, 6],
                            hora: turnOnTime
                        };
                    }

                    // Guardar hora de apagado en parametros
                    if (turnOffTime) {
                        taskData.acciones[0].parametros = {
                            horaApagar: turnOffTime
                        };
                    }
                } else if (lightDiv && lightDiv.style.display !== 'none') {
                    const turnOnTime = document.querySelector('.light #turnOnTime').value;
                    const turnOffTime = document.querySelector('.light #turnOffTime').value;

                    if (turnOnTime) {
                        taskData.trigger.horario = {
                            dias: [0, 1, 2, 3, 4, 5, 6],
                            hora: turnOnTime
                        };
                    }

                    // Guardar hora de apagado en parametros
                    if (turnOffTime) {
                        taskData.acciones[0].parametros = {
                            horaApagar: turnOffTime
                        };
                    }
                } else if (fanDiv && fanDiv.style.display !== 'none') {
                    const turnOnTime = document.getElementById('turnOnTime').value;
                    const turnOffTime = document.getElementById('turnOffTime').value;
                    const turnOnTemp = document.getElementById('turnOnTemp').value;
                    const turnOffTemp = document.getElementById('turnOffTemp').value;

                    if (turnOnTime) {
                        taskData.trigger.horario = {
                            dias: [0, 1, 2, 3, 4, 5, 6],
                            hora: turnOnTime
                        };
                    }

                    // Guardar parámetros adicionales
                    const parametros = {};
                    if (turnOffTime) parametros.horaApagar = turnOffTime;
                    if (turnOnTemp) parametros.temperaturaEncender = parseFloat(turnOnTemp);
                    if (turnOffTemp) parametros.temperaturaApagar = parseFloat(turnOffTemp);

                    if (Object.keys(parametros).length > 0) {
                        taskData.acciones[0].parametros = parametros;
                    }
                }

                // Crear la automatización
                const response = await fetchWithAuth(`${API_URL}/automatize`, {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Automatización creada exitosamente');
                    window.location.href = 'automatize.html';
                } else {
                    alert(data.message || 'Error al crear la automatización');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            }
        });

        // Cargar cuando la página esté lista
        document.addEventListener('DOMContentLoaded', loadDevices);
    </script>
</body>
</html>