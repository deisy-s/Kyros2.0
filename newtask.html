<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Información de dispositivo - KYROS</title>
    <link rel="icon" href="images/logo.ico" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand me-auto" href="index.html">
                <img src="images/logo.png" height="40px" alt="KYROS logo">
                <h3 class="logoH">KYROS</h3>
            </a>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">KYROS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-center flex-grow-1 pe-3">
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" aria-current="page" href="index.html">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="rooms.html">Habitaciones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="security.html">Seguridad</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2 active" href="automatize.html">Automatización</a>
                        </li>
                    </ul>
                </div>
            </div>
            <a href="login.html" class="login-button">Iniciar sesión</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
    <!-- End navbar -->

    <!-- Content -->
    <div class="container" id="main-container-addtask">
        <div class="row">
            <!-- Breadcrumb -->
            <nav class="d-flex">
            <h6 class="mb-0" id="breadcrumb">
                <a href="index.html" class="text-reset">Inicio</a>
                <span>></span>
                <a href="automatize.html" class="text-reset">Automatización</a>
                <span>></span>
                <a href="#" class="text-reset">Agregar tarea</a>
            </h6>
            </nav>
            <!-- Breadcrumb -->
        </div>
        <div class="row">
            <h1 class="heading">Agregar tarea</h1>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="row name" id="name">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <h3>Nombre de tarea</h3>
                        <input type="text" id="name-input" name="taskName">
                        <br>
                        <button class="mt-2" id="task-button" onclick="nameClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Post It .png" alt="Image">
                </div>
            </div>
            <div class="row dev" id="dev" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <h3>Nombre de actuador</h3>
                        <div class="dropdown">
                            <button
                                class="btn btn-primary dropdown-toggle"
                                data-bs-toggle="dropdown"
                                type="button"
                                id="dropdownMenuButton"
                                data-mdb-dropdown-init
                                data-mdb-ripple-init
                                aria-expanded="false"
                            >
                                Seleccione un dispositivo
                            </button>
                            <ul class="dropdown-menu w-100" id="tableMenu" aria-labelledby="dropdownMenuButton">
                                <!-- Los dispositivos se cargan dinámicamente desde el API -->
                            </ul>
                        </div>
                        <br>
                        <button id="task-button" onclick="devClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/SEO.png" alt="Image">
                </div>
            </div>

            <div class="row start-fan" id="start-fan" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-fan">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOptionButton"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="optionMenu" aria-labelledby="dropdownOptionButton">
                                    <li><a class="dropdown-item option" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option" href="#">Encender a una temperatura establecida</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOn" style="display: none !important;">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTime"
                                min="00:00"
                                max="24:00"
                            />
                        </div>
                        <br>
                        <div class="d-flex" id="tempOn" style="display: none !important;">
                            <h3>Encender cuando llegue a</h3>
                            <input type="number" id="turnOnTemp">
                            <h3 class="degree">°C</h3>
                        </div>
                        <br>
                        <button id="task-button" onclick="startFanClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>
            <div class="row stop-fan" id="stop-fan" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-fan-off">
                            <h3>Opciones para apagar</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption2Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option2Menu" aria-labelledby="dropdownOption2Button">
                                    <li><a class="dropdown-item option2" href="#">Apagar a una hora establecida</a></li>
                                    <li><a class="dropdown-item option2" href="#">Apagar a una temperatura establecida</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOff" style="display: none !important;">
                            <h3>Apagar a la(s)</h3>
                            <input
                            type="time"
                            id="turnOffTime"
                            min="00:00"
                            max="24:00"
                            required />
                        </div>
                        <br>
                        <div class="d-flex" id="tempOff" style="display: none !important;">
                            <h3>Apagar a cuando llegue a</h3>
                            <input type="number" id="turnOffTemp">
                            <h3 class="degree">°C</h3>
                        </div>
                        <br>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row start-light" id="start-light" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-light-on">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption3Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option3Menu" aria-labelledby="dropdownOption3Button">
                                    <li><a class="dropdown-item option3" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option3" href="#">Encender cuando no hay luz</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOnLight" style="display: none !important;">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTimeLight"
                                min="00:00"
                                max="24:00"
                                required 
                            />
                        </div>
                        <br>
                        <button id="task-button" onclick="startLightClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>
            <div class="row stop-light" id="stop-light" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-light-off">
                            <h3>Opciones para apagar</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption4Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option4Menu" aria-labelledby="dropdownOption4Button">
                                    <li><a class="dropdown-item option4" href="#">Apagar a una hora establecida</a></li>
                                    <li><a class="dropdown-item option4" href="#">Apagar cuando hay luz</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOffLight" style="display: none !important;">
                            <h3>Apagar a la(s)</h3>
                            <input
                                type="time"
                                id="turnOffTimeLight"
                                min="00:00"
                                max="24:00"
                                required 
                            />
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row alarm" id="alarm" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="turnOnAlarm">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption5Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option5Menu" aria-labelledby="dropdownOption5Button">
                                    <li><a class="dropdown-item option5" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option5" href="#">Encender al detectar movimiento</a></li>
                                    <li><a class="dropdown-item option5" href="#">Encender al sobrepasar los niveles de gas regulares</a></li>
                                </ul>
                            </div>
                            <div id="timeAlarm" style="display: none;">
                                <div class="d-flex mt-3">
                                    <h3>Encender a la(s)</h3>
                                    <input type="time" id="turnOnTimeAlarm" min="00:00" max="24:00" />
                                </div>
                                <div class="d-flex mt-3">
                                    <h3>Apagar a la(s)</h3>
                                    <input type="time" id="turnOffTimeAlarm" min="00:00" max="24:00" />
                                </div>
                            </div>
                            <div id="movementAlarm" style="display: none;">
                                <h3 class="mt-3">Seleccionar sensor de movimiento</h3>
                                <div class="dropdown">
                                    <button
                                        class="btn btn-primary dropdown-toggle"
                                        data-bs-toggle="dropdown"
                                        type="button"
                                        id="dropdownMovementButton"
                                        data-mdb-dropdown-init
                                        data-mdb-ripple-init
                                        aria-expanded="false"
                                    >
                                    </button>
                                    <ul class="dropdown-menu w-150" id="MovementMenu" aria-labelledby="dropdownMovementButton">
                                        <!-- Sensores de movimiento cargados dinámicamente -->
                                    </ul>
                                </div>
                                <h3 class="mt-3">Sonar cuando se detecta movimiento entre</h3>
                                <div class="row">
                                    <div class="col-5">
                                        <input
                                            type="time"
                                            id="startRange"
                                            min="00:00"
                                            max="24:00"
                                        />
                                    </div>
                                    <div class="col-2 d-flex justify-content-center">
                                        <h3 class="mt-1">-</h3>
                                    </div>
                                    <div class="col-5">
                                        <input
                                            type="time"
                                            id="stopRange"
                                            min="00:00"
                                            max="24:00"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div id="gasAlarm" style="display: none;">
                                <h3 class="mt-3">Seleccionar sensor de gas</h3>
                                <div class="dropdown">
                                    <button
                                        class="btn btn-primary dropdown-toggle"
                                        data-bs-toggle="dropdown"
                                        type="button"
                                        id="dropdownGasButton"
                                        data-mdb-dropdown-init
                                        data-mdb-ripple-init
                                        aria-expanded="false"
                                    >
                                    </button>
                                    <ul class="dropdown-menu w-150" id="GasMenu" aria-labelledby="dropdownGasButton">
                                        <!-- Sensores de gas cargados dinámicamente -->
                                    </ul>
                                </div>
                            </div>
                            <div id="durationAlarm" style="display: none;">
                                <h3 class="mt-4">Duración de alarma</h3>
                                <div class="row d-flex align-items-center">
                                    <input type="number" class="col-4" id="seconds" placeholder="00">
                                    <p class="col-4">segundos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row actuador" id="actuador" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div class="d-flex" id="turnOnActuador">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTimeActuador"
                                min="00:00"
                                max="24:00"
                                required
                            />
                        </div>
                        <br>
                        <div class="d-flex" id="turnOffActuador">
                            <h3>Apagar a la(s)</h3>
                            <input
                                type="time"
                                id="turnOffTimeActuador"
                                min="00:00"
                                max="24:00"
                            />
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="col-lg-5 mt-3" id="btn-div" style="display: none;">
                <button id="task-button">Guardar</button>
            </div>
        </div>
    </div>
    <!-- End content -->

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <img src="images/logo.png" alt="KYROS logo" height="40px">
                        <h3 class="logo-h3">KYROS</h3>
                        <p>Manten el control sobre tu hogar</p>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Soporte</h2>
                        <ul>
                            <li><a href="helpcenter.html">Centro de ayuda</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Contáctenos</h2>
                        <p>687-123-4567</p>
                        <p>test@outlook.com</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <h3 class="copyright">&copy;2025 Instituto Tecnológico Superior de Guasave</h3>
            </div>
        </div>

    </footer>
    <!-- End footer -->

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="js/auth.js"></script>
    <script src="js/navbar.js"></script>

    <!-- SweetAlert Javascript -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!-- Frontend JavaScript -->
    <script>
        // API_URL ya está definido en js/auth.js
        let selectedDeviceId = null;
        let selectedDeviceType = null;

        // Cargar dispositivos del usuario dinámicamente (SOLO ACTUADORES)
        async function loadDevices() {
            try {
                const response = await fetchWithAuth(`${API_URL}/devices`);
                const data = await response.json();

                if (data.success) {
                    const dropdown = document.getElementById('tableMenu');
                    const dropdownButton = document.getElementById('dropdownMenuButton');

                    dropdown.innerHTML = '';

                    // Filtrar solo actuadores
                    const actuadores = data.data.filter(device => device.tipo === 'actuador');

                    if (actuadores.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay actuadores</a></li>';
                        dropdownButton.textContent = 'Sin actuadores';
                        return;
                    }

                    // Agregar solo actuadores al dropdown
                    actuadores.forEach(device => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item';
                        a.href = '#';
                        const habitacionNombre = device.habitacion?.nombre || 'Sin habitación';
                        a.textContent = `${device.nombre} (${habitacionNombre})`;
                        a.onclick = (e) => {
                            e.preventDefault();
                            selectedDeviceId = device._id;
                            selectedDeviceType = device.tipo;
                            dropdownButton.textContent = device.nombre;
                        };
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });

                    // Pre-seleccionar el primero
                    if (actuadores.length > 0) {
                        selectedDeviceId = actuadores[0]._id;
                        selectedDeviceType = actuadores[0].tipo;
                        dropdownButton.textContent = actuadores[0].nombre;
                    }
                }
            } catch (error) {
                console.error('Error al cargar dispositivos:', error);
                swal("Error", "Error al cargar los dispositivos", "error");
            }
        }

        // Cargar sensores de movimiento dinámicamente
        async function loadMovementSensors() {
            try {
                const response = await fetchWithAuth(`${API_URL}/devices?tipo=movimiento`);
                const data = await response.json();

                if (data.success) {
                    const dropdown = document.getElementById('MovementMenu');
                    const dropdownButton = document.getElementById('dropdownMovementButton');

                    dropdown.innerHTML = '';

                    if (data.data.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay sensores de movimiento</a></li>';
                        dropdownButton.textContent = 'Sin sensores';
                        return;
                    }

                    data.data.forEach(sensor => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item movement';
                        a.href = '#';
                        const habitacionNombre = sensor.habitacion?.nombre || 'Sin habitación';
                        a.textContent = `${sensor.nombre} (${habitacionNombre})`;
                        a.dataset.sensorId = sensor._id;
                        a.onclick = (e) => {
                            e.preventDefault();
                            dropdownButton.textContent = sensor.nombre;
                            dropdownButton.dataset.sensorId = sensor._id;
                        };
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });

                    dropdownButton.textContent = 'Seleccionar sensor';
                }
            } catch (error) {
                console.error('Error al cargar sensores de movimiento:', error);
            }
        }

        // Cargar sensores de gas dinámicamente
        async function loadGasSensors() {
            try {
                const response = await fetchWithAuth(`${API_URL}/devices?tipo=gas`);
                const data = await response.json();

                if (data.success) {
                    const dropdown = document.getElementById('GasMenu');
                    const dropdownButton = document.getElementById('dropdownGasButton');

                    dropdown.innerHTML = '';

                    if (data.data.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay sensores de gas</a></li>';
                        dropdownButton.textContent = 'Sin sensores';
                        return;
                    }

                    data.data.forEach(sensor => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item gas';
                        a.href = '#';
                        const habitacionNombre = sensor.habitacion?.nombre || 'Sin habitación';
                        a.textContent = `${sensor.nombre} (${habitacionNombre})`;
                        a.dataset.sensorId = sensor._id;
                        a.onclick = (e) => {
                            e.preventDefault();
                            dropdownButton.textContent = sensor.nombre;
                            dropdownButton.dataset.sensorId = sensor._id;
                        };
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });

                    dropdownButton.textContent = 'Seleccionar sensor';
                }
            } catch (error) {
                console.error('Error al cargar sensores de gas:', error);
            }
        }

        // Cargar dispositivos y sensores cuando la página esté lista
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            loadMovementSensors();
            loadGasSensors();
        });
    
        // Dropdown para opciones de encender abanico
        const dropdownOption = document.querySelectorAll('#optionMenu .option');

        dropdownOption.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOptionButton');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOn");
                let temp = document.getElementById("tempOn");
                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                    temp.classList.remove('d-flex');
                    temp.style.display="none";
                    document.getElementById("turnOnTemp").value = ""; // Asegurar que se limpie el input que no está en uso
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    document.getElementById("turnOnTime").value = ""; // Asegurar que se limpie el input que no está en uso
                    temp.classList.add('d-flex');
                    temp.style.display="flex";
                }
            });
        });
    
        // Dropdown de opciones para apagar abanico
        const dropdownOption2 = document.querySelectorAll('#option2Menu .option2');

        dropdownOption2.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption2Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOff");
                let temp = document.getElementById("tempOff");
                if(dropdownButton.innerText === "Apagar a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                    temp.classList.remove('d-flex');
                    temp.style.display="none";
                    document.getElementById("turnOffTemp").value = ""; // Asegurar que se limpie el input que no está en uso
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    temp.classList.add('d-flex');
                    temp.style.display="flex";
                    document.getElementById("turnOffTime").value = ""; // Asegurar que se limpie el input que no está en uso
                }
            });
        });
    
        // Dropdown de opciones para encender foco
        const dropdownOption3 = document.querySelectorAll('#option3Menu .option3');

        dropdownOption3.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption3Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOnLight");
                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    document.getElementById("turnOnTimeLight").value = ""; // Asegurar que se limpie el input que no está en uso
                }
            });
        });
    
        // Dropdown de opciones para apagar foco
        const dropdownOption4 = document.querySelectorAll('#option4Menu .option4');

        dropdownOption4.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption4Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOffLight");
                if(dropdownButton.innerText === "Apagar a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    document.getElementById("turnOffTimeLight").value = ""; // Asegurar que se limpie el input que no está en uso
                }
            });
        });

        // Dropdown de opciones para alarma/actuador
        const dropdownOption5 = document.querySelectorAll('#option5Menu .option5');

        dropdownOption5.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption5Button');
                dropdownButton.textContent = item.textContent;

                let timeDiv = document.getElementById("timeAlarm");
                let gas = document.getElementById("gasAlarm");
                let move = document.getElementById("movementAlarm");
                let dur = document.getElementById("durationAlarm");

                // Ocultar todos primero
                timeDiv.style.display = "none";
                gas.style.display = "none";
                move.style.display = "none";
                dur.style.display = "none";

                // Limpiar campos
                document.getElementById("turnOnTimeAlarm").value = "";
                document.getElementById("turnOffTimeAlarm").value = "";
                document.getElementById("dropdownGasButton").innerText = "";
                document.getElementById("dropdownMovementButton").innerText = "";
                document.getElementById("startRange").value = "";
                document.getElementById("stopRange").value = "";
                document.getElementById("seconds").value = "";

                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    timeDiv.style.display = "block";
                } else if(dropdownButton.innerText === "Encender al detectar movimiento"){
                    move.style.display = "block";
                    dur.style.display = "block";
                } else if(dropdownButton.innerText === "Encender al sobrepasar los niveles de gas regulares"){
                    gas.style.display = "block";
                    dur.style.display = "block";
                }
            });
        });

        // Dropdown de opciones para seleccionar sensor de movimiento
        const dropdownMovement = document.querySelectorAll('#MovementMenu .movement');

        dropdownMovement.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownMovementButton');
                dropdownButton.textContent = item.textContent;
            });
        });

        // Dropdown de opciones para seleccionar sensor de gas
        const gasMovement = document.querySelectorAll('#GasMenu .gas');

        gasMovement.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownGasButton');
                dropdownButton.textContent = item.textContent;
            });
        });

        function nameClick(){
            let n = document.getElementById("name-input").value;
            if(n.trim()!==""){
                let ndiv = document.getElementById("name");
                let ddiv = document.getElementById("dev");

                ndiv.style.display = "none";
                ddiv.style.display = "flex";
                ddiv.classList.add('swing-in-bottom-bck');
            } else {
                swal("Campo vacío", "Favor de ingresar un nombre", "warning");
            }
        }

        function devClick(){
            let n = document.getElementById("dropdownMenuButton").textContent;
            if(n.trim()!=="" && n !== "Seleccione un dispositivo" && n !== "Sin dispositivos"){
                let ddiv = document.getElementById("dev");
                ddiv.style.display = "none";

                // Evaluar el tipo de dispositivo para mostrar el formulario correcto
                if (selectedDeviceType === 'luz') {
                    let lightDiv = document.getElementById("start-light");
                    lightDiv.style.display = "flex";
                    lightDiv.classList.add('swing-in-bottom-bck');
                } else if (selectedDeviceType === 'temperatura' || selectedDeviceType === 'humedad') {
                    let fanDiv = document.getElementById("start-fan");
                    fanDiv.style.display = "flex";
                    fanDiv.classList.add('swing-in-bottom-bck');
                } else if (selectedDeviceType === 'actuador') {
                    // Los actuadores usan el formulario de alarma con todas las opciones
                    let alarmDiv = document.getElementById("alarm");
                    let save = document.getElementById("btn-div");

                    alarmDiv.style.display = "flex";
                    save.style.display = "flex";
                    alarmDiv.classList.add('swing-in-bottom-bck');
                    save.classList.add('swing-in-bottom-bck');
                } else {
                    // Por defecto, mostrar ventilador para otros tipos (enchufe, cerradura, etc.)
                    let fanDiv = document.getElementById("start-fan");
                    fanDiv.style.display = "flex";
                    fanDiv.classList.add('swing-in-bottom-bck');
                }
            } else {
                swal("Campo vacío", "Favor de seleccionar un dispositivo", "warning");
            }
        }

        function startFanClick(){
            let time = document.getElementById("turnOnTime").value;
            let temp = document.getElementById("turnOnTemp").value;
            if((time.trim()!=="" && temp.trim()==="") || (temp.trim()!=="" && time.trim()==="")){
                let startdiv = document.getElementById("start-fan");
                let stopdiv = document.getElementById("stop-fan");
                let save = document.getElementById("btn-div");

                startdiv.style.display = "none";
                stopdiv.style.display = "flex";
                save.style.display = "flex"
                stopdiv.classList.add('swing-in-bottom-bck');
                save.classList.add('swing-in-bottom-bck');
            } else{
                swal("Campos vacíos", "Favor de seleccionar e ingresar una opción", "warning");
            }
        }

        function startLightClick(){
            let time = document.getElementById("turnOnTimeLight").value;
            let noLight = document.getElementById("dropdownOption3Button").textContent;
            if((time.trim()!=="") || (noLight==="Encender cuando no hay luz")){
                let startdiv = document.getElementById("start-light");
                let stopdiv = document.getElementById("stop-light");
                let save = document.getElementById("btn-div");

                startdiv.style.display = "none";
                stopdiv.style.display = "flex";
                save.style.display = "flex"
                stopdiv.classList.add('swing-in-bottom-bck');
                save.classList.add('swing-in-bottom-bck');
            } else{
                swal("Campos vacíos", "Favor de seleccionar una opción", "warning");
            }
        }

        // ============ FUNCIONALIDAD DEL BOTÓN GUARDAR ============
        document.addEventListener('DOMContentLoaded', function() {
            const saveButton = document.querySelector('#btn-div #task-button');

            if (saveButton) {
                saveButton.addEventListener('click', async function(e) {
                    e.preventDefault();

                    // Obtener el nombre de la tarea
                    const taskName = document.getElementById("name-input").value.trim();

                    if (!taskName) {
                        swal("Campo vacío", "Favor de ingresar el nombre de la tarea", "warning");
                        return;
                    }

                    if (!selectedDeviceId) {
                        swal("Error", "No se seleccionó ningún dispositivo", "warning");
                        return;
                    }

                    try {
                        // Estructura base de la automatización
                        const taskData = {
                            nombre: taskName,
                            descripcion: '',
                            activa: true,
                            trigger: {
                                tipo: 'horario'
                            },
                            acciones: [{
                                dispositivo: selectedDeviceId,
                                accion: 'encender',
                                parametros: {},
                                orden: 0
                            }]
                        };

                        // Usar el tipo de dispositivo seleccionado en lugar de verificar divs visibles
                        let isValid = false;

                        // SI ES TEMPERATURA/HUMEDAD (usan formulario de temperatura)
                        if (selectedDeviceType === 'temperatura' || selectedDeviceType === 'humedad') {
                            const turnOnTime = document.getElementById("turnOnTime").value;
                            const turnOnTemp = document.getElementById("turnOnTemp").value;
                            const turnOffTime = document.getElementById("turnOffTime").value;
                            const turnOffTemp = document.getElementById("turnOffTemp").value;

                            // Validar que al menos un campo de encendido esté lleno
                            if (!turnOnTime && !turnOnTemp) {
                                swal("Campos vacíos", "Favor de ingresar una hora o temperatura para encender", "warning");
                                return;
                            }

                            // Configurar trigger (usar hora si está disponible)
                            if (turnOnTime) {
                                taskData.trigger.horario = {
                                    dias: [0, 1, 2, 3, 4, 5, 6],
                                    hora: turnOnTime
                                };
                            }

                            // Agregar parámetros
                            const parametros = {};
                            if (turnOnTemp) parametros.temperaturaEncender = parseFloat(turnOnTemp);
                            if (turnOffTime) parametros.horaApagar = turnOffTime;
                            if (turnOffTemp) parametros.temperaturaApagar = parseFloat(turnOffTemp);

                            if (Object.keys(parametros).length > 0) {
                                taskData.acciones[0].parametros = parametros;
                            }

                            isValid = true;
                        }
                        // SI ES LUZ
                        else if (selectedDeviceType === 'luz') {
                            const turnOnTimeLight = document.getElementById("turnOnTimeLight").value;
                            const turnOffTimeLight = document.getElementById("turnOffTimeLight").value;
                            const lightOption = document.getElementById("dropdownOption3Button").textContent;

                            // Validar que tenga hora o la opción "Encender cuando no hay luz"
                            if (!turnOnTimeLight && lightOption !== "Encender cuando no hay luz") {
                                swal("Campos vacíos", "Favor de seleccionar una opción para encender", "warning");
                                return;
                            }

                            // Configurar trigger
                            if (turnOnTimeLight) {
                                taskData.trigger.horario = {
                                    dias: [0, 1, 2, 3, 4, 5, 6],
                                    hora: turnOnTimeLight
                                };
                            }

                            // Agregar parámetros
                            const parametros = {};
                            if (turnOffTimeLight) parametros.horaApagar = turnOffTimeLight;
                            if (lightOption === "Encender cuando no hay luz") parametros.encenderSinLuz = true;

                            const lightOffOption = document.getElementById("dropdownOption4Button").textContent;
                            if (lightOffOption === "Apagar cuando hay luz") parametros.apagarConLuz = true;

                            if (Object.keys(parametros).length > 0) {
                                taskData.acciones[0].parametros = parametros;
                            }

                            isValid = true;
                        }
                        // SI ES MOVIMIENTO/GAS (alarmas)
                        else if (selectedDeviceType === 'movimiento' || selectedDeviceType === 'gas') {
                            const turnOn = document.getElementById("turnOn").value;
                            const durMinute = document.getElementById("minutes").value;
                            const durSeconds = document.getElementById("seconds").value;

                            if (!turnOn) {
                                swal("Campo vacío", "Favor de ingresar la hora de activación", "warning");
                                return;
                            }

                            if(!durMinute && !durSeconds){
                                swal("Campo vacío", "Favor de el tiempo de duración de la alarma", "warning");
                                return;
                            }

                            taskData.trigger.horario = {
                                dias: [0, 1, 2, 3, 4, 5, 6],
                                hora: turnOn
                            };

                            taskData.acciones[0].accion = 'encender';
                            isValid = true;
                        }
                        // SI ES ACTUADOR (usa formulario de alarma con 3 opciones)
                        else if (selectedDeviceType === 'actuador') {
                            const opcionSeleccionada = document.getElementById("dropdownOption5Button").textContent;

                            if (!opcionSeleccionada || opcionSeleccionada.trim() === '') {
                                swal("Campo vacío", "Favor de seleccionar una opción para encender", "warning");
                                return;
                            }

                            // Opción 1: Por hora
                            if (opcionSeleccionada === "Encender a una hora establecida") {
                                const turnOnTime = document.getElementById("turnOnTimeAlarm").value;
                                const turnOffTime = document.getElementById("turnOffTimeAlarm").value;

                                if (!turnOnTime) {
                                    swal("Campo vacío", "Favor de ingresar la hora de encendido", "warning");
                                    return;
                                }

                                taskData.trigger.tipo = 'horario';
                                taskData.trigger.horario = {
                                    dias: [0, 1, 2, 3, 4, 5, 6],
                                    hora: turnOnTime
                                };

                                if (turnOffTime) {
                                    taskData.acciones[0].parametros = { horaApagar: turnOffTime };
                                }
                            }
                            // Opción 2: Por sensor de movimiento
                            else if (opcionSeleccionada === "Encender al detectar movimiento") {
                                const sensorId = document.getElementById("dropdownMovementButton").dataset.sensorId;
                                const startRange = document.getElementById("startRange").value;
                                const stopRange = document.getElementById("stopRange").value;
                                const duracion = document.getElementById("seconds").value;

                                if (!sensorId) {
                                    swal("Campo vacío", "Favor de seleccionar un sensor de movimiento", "warning");
                                    return;
                                }

                                taskData.trigger.tipo = 'sensor';
                                taskData.trigger.sensor = {
                                    dispositivo: sensorId,
                                    tipoSensor: 'movimiento',
                                    condicion: { operador: 'igual', valor: true }
                                };

                                taskData.acciones[0].parametros = {
                                    rangoInicio: startRange || null,
                                    rangoFin: stopRange || null,
                                    duracionSegundos: duracion ? parseInt(duracion) : null
                                };
                            }
                            // Opción 3: Por sensor de gas
                            else if (opcionSeleccionada === "Encender al sobrepasar los niveles de gas regulares") {
                                const sensorId = document.getElementById("dropdownGasButton").dataset.sensorId;
                                const duracion = document.getElementById("seconds").value;

                                if (!sensorId) {
                                    swal("Campo vacío", "Favor de seleccionar un sensor de gas", "warning");
                                    return;
                                }

                                taskData.trigger.tipo = 'sensor';
                                taskData.trigger.sensor = {
                                    dispositivo: sensorId,
                                    tipoSensor: 'gas',
                                    condicion: { operador: 'mayor', valor: 800 } // Umbral de gas
                                };

                                taskData.acciones[0].parametros = {
                                    duracionSegundos: duracion ? parseInt(duracion) : null
                                };
                            }

                            taskData.acciones[0].accion = 'encender';
                            isValid = true;
                        }
                        // OTROS TIPOS (enchufe, cerradura, etc.) - usar formulario de temperatura por defecto
                        else if (selectedDeviceType) {
                            const turnOnTime = document.getElementById("turnOnTime").value;
                            const turnOnTemp = document.getElementById("turnOnTemp").value;
                            const turnOffTime = document.getElementById("turnOffTime").value;
                            const turnOffTemp = document.getElementById("turnOffTemp").value;

                            // Validar que al menos un campo de encendido esté lleno
                            if (!turnOnTime && !turnOnTemp) {
                                swal("Campos vacíos", "Favor de ingresar una hora o temperatura para encender", "warning");
                                return;
                            }

                            // Configurar trigger
                            if (turnOnTime) {
                                taskData.trigger.horario = {
                                    dias: [0, 1, 2, 3, 4, 5, 6],
                                    hora: turnOnTime
                                };
                            }

                            // Agregar parámetros
                            const parametros = {};
                            if (turnOnTemp) parametros.temperaturaEncender = parseFloat(turnOnTemp);
                            if (turnOffTime) parametros.horaApagar = turnOffTime;
                            if (turnOffTemp) parametros.temperaturaApagar = parseFloat(turnOffTemp);

                            if (Object.keys(parametros).length > 0) {
                                taskData.acciones[0].parametros = parametros;
                            }

                            isValid = true;
                        }

                        if (!isValid) {
                            swal("Error", "No se seleccionó un tipo de dispositivo válido", "error");
                            return;
                        }

                        // Enviar al servidor
                        const response = await fetchWithAuth(`${API_URL}/automatize`, {
                            method: 'POST',
                            body: JSON.stringify(taskData)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            await swal({title:"Tarea creada exitosamente", icon:"success",});
                            setTimeout(() => {
                                window.location.href = 'automatize.html';
                            }, 1500);
                        } else {
                            swal("Error", data.message || "Error al crear la tarea", "error");
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        swal("Error", "Error al conectar con el servidor", "error");
                    }
                });
            }
        });
    </script>
</body>
</html>