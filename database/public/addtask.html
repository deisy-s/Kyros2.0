<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Informaci√≥n de dispositivo - KYROS</title>
    <link rel="icon" href="images/logo.ico" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand me-auto" href="index.html">
                <img src="images/logo.png" height="40px" alt="KYROS logo">
                <h3 class="logoH">KYROS</h3>
            </a>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">KYROS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-center flex-grow-1 pe-3">
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" aria-current="page" href="index.html">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2 active" href="rooms.html">Habitaciones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="security.html">Seguridad</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="automatize.html">Automatizaci√≥n</a>
                        </li>
                    </ul>
                </div>
            </div>
            <a href="login.html" class="login-button">Iniciar sesi√≥n</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
    <!-- End navbar -->

    <!-- Content -->
    <div class="container" id="main-container-addroom">
        <div class="row">
            <!-- Breadcrumb -->
            <nav class="d-flex">
            <h6 class="mb-0" id="breadcrumb">
                <a href="index.html" class="text-reset">Inicio</a>
                <span>></span>
                <a href="rooms.html" class="text-reset">Habitaciones</a>
                <span>></span>
                <a href="#" class="text-reset" id="roomRoute" onclick="sendRoom()"></a>
                <span>></span>
                <a href="#" class="text-reset" id="deviceRoute" onclick="sendDevice()"></a>
                <span>></span>
                <a href="#" class="text-reset">Agregar tarea</a>
            </h6>
            </nav>
            <!-- Breadcrumb -->
        </div>
        <div class="row">
            <h1 class="heading">Agregar tarea</h1>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="row name" id="name">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <h3>Nombre de tarea</h3>
                        <input type="text" id="name-input" name="taskName">
                        <br>
                        <button class="mt-2" id="task-button" onclick="nameClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Post It .png" alt="Image">
                </div>
            </div>

            <div class="row start-fan" id="start-fan" style="display: none !important;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-fan">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOptionButton"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="optionMenu" aria-labelledby="dropdownOptionButton">
                                    <li><a class="dropdown-item option" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option" href="#">Encender a una temperatura establecida</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOn" style="display: none !important;">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTime"
                                min="00:00"
                                max="24:00"
                            />
                        </div>
                        <br>
                        <div class="d-flex" id="tempOn" style="display: none !important;">
                            <div class="row">
                                <div>
                                    <h3 class="mt-3">Seleccionar sensor de temperatura</h3>
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-primary dropdown-toggle"
                                            data-bs-toggle="dropdown"
                                            type="button"
                                            id="dropdownTempOnButton"
                                            data-mdb-dropdown-init
                                            data-mdb-ripple-init
                                            aria-expanded="false"
                                        >
                                        </button>
                                        <ul class="dropdown-menu w-150" id="TempOnMenu" aria-labelledby="dropdownTempOnButton">
                                            <!-- Sensores de temperatura cargados din√°micamente -->
                                            <li><a class="dropdown-item optionTempOn" href="#">Nombre</a></li>
                                            <li><a class="dropdown-item optionTempOn" href="#">Nombre2</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="d-flex">
                                    <h3>Encender cuando llegue a</h3>
                                    <input type="number" id="turnOnTemp">
                                    <h3 class="degree">¬∞C</h3>
                                </div>
                            </div>
                        </div>
                        <br>
                        <button id="task-button" onclick="startFanClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>
            <div class="row stop-fan" id="stop-fan" style="display: none !important;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-fan-off">
                            <h3>Opciones para apagar</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption2Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option2Menu" aria-labelledby="dropdownOption2Button">
                                    <li><a class="dropdown-item option2" href="#">Apagar a una hora establecida</a></li>
                                    <li><a class="dropdown-item option2" href="#">Apagar a una temperatura establecida</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOff" style="display: none !important;">
                            <h3>Apagar a la(s)</h3>
                            <input
                            type="time"
                            id="turnOffTime"
                            min="00:00"
                            max="24:00"
                            required />
                        </div>
                        <br>
                        <div class="d-flex" id="tempOff" style="display: none !important;">
                            <div class="row">
                                <div>
                                    <h3 class="mt-3">Seleccionar sensor de temperatura</h3>
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-primary dropdown-toggle"
                                            data-bs-toggle="dropdown"
                                            type="button"
                                            id="dropdownTempOffButton"
                                            data-mdb-dropdown-init
                                            data-mdb-ripple-init
                                            aria-expanded="false"
                                        >
                                        </button>
                                        <ul class="dropdown-menu w-150" id="TempOffMenu" aria-labelledby="dropdownTempOffButton">
                                            <!-- Sensores de temperatura cargados din√°micamente -->
                                            <li><a class="dropdown-item optionTempOff" href="#">Nombre</a></li>
                                            <li><a class="dropdown-item optionTempOff" href="#">Nombre 3</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="d-flex">
                                    <h3>Apagar cuando llegue a</h3>
                                    <input type="number" id="turnOffTemp">
                                    <h3 class="degree">¬∞C</h3>
                                </div>
                            </div>
                        </div>
                        <br>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row start-light" id="start-light" style="display: none !important;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-light-on">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption3Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option3Menu" aria-labelledby="dropdownOption3Button">
                                    <li><a class="dropdown-item option3" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option3" href="#">Encender cuando no hay luz</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOnLight" style="display: none !important;">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTimeLight"
                                min="00:00"
                                max="24:00"
                                required 
                            />
                        </div>
                        <br>
                        <button id="task-button" onclick="startLightClick()">Continuar</button>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>
            <div class="row stop-light" id="stop-light" style="display: none !important;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="option-light-off">
                            <h3>Opciones para apagar</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption4Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option4Menu" aria-labelledby="dropdownOption4Button">
                                    <li><a class="dropdown-item option4" href="#">Apagar a una hora establecida</a></li>
                                    <li><a class="dropdown-item option4" href="#">Apagar cuando hay luz</a></li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex" id="timeOffLight" style="display: none !important;">
                            <h3>Apagar a la(s)</h3>
                            <input
                                type="time"
                                id="turnOffTimeLight"
                                min="00:00"
                                max="24:00"
                                required 
                            />
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row alarm" id="alarm" style="display: none;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div id="turnOnAlarm">
                            <h3>Opciones para encender</h3>
                            <div class="dropdown">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    type="button"
                                    id="dropdownOption5Button"
                                    data-mdb-dropdown-init
                                    data-mdb-ripple-init
                                    aria-expanded="false"
                                >
                                </button>
                                <ul class="dropdown-menu w-150" id="option5Menu" aria-labelledby="dropdownOption5Button">
                                    <li><a class="dropdown-item option5" href="#">Encender a una hora establecida</a></li>
                                    <li><a class="dropdown-item option5" href="#">Encender al detectar movimiento</a></li>
                                    <li><a class="dropdown-item option5" href="#">Encender al sobrepasar los niveles de gas regulares</a></li>
                                </ul>
                            </div>
                            <div id="timeAlarm" style="display: none;">
                                <div class="d-flex mt-3">
                                    <h3>Encender a la(s)</h3>
                                    <input type="time" id="turnOnTimeAlarm" min="00:00" max="24:00" />
                                </div>
                                <div class="d-flex mt-3">
                                    <h3>Apagar a la(s)</h3>
                                    <input type="time" id="turnOffTimeAlarm" min="00:00" max="24:00" />
                                </div>
                            </div>
                            <div id="movementAlarm" style="display: none;">
                                <h3 class="mt-3">Seleccionar sensor de movimiento</h3>
                                <div class="dropdown">
                                    <button
                                        class="btn btn-primary dropdown-toggle"
                                        data-bs-toggle="dropdown"
                                        type="button"
                                        id="dropdownMovementButton"
                                        data-mdb-dropdown-init
                                        data-mdb-ripple-init
                                        aria-expanded="false"
                                    >
                                    </button>
                                    <ul class="dropdown-menu w-150" id="MovementMenu" aria-labelledby="dropdownMovementButton">
                                        <!-- Sensores de movimiento cargados din√°micamente -->
                                    </ul>
                                </div>
                                <h3 class="mt-3">Sonar cuando se detecta movimiento entre</h3>
                                <div class="row">
                                    <div class="col-5">
                                        <input
                                            type="time"
                                            id="startRange"
                                            min="00:00"
                                            max="24:00"
                                        />
                                    </div>
                                    <div class="col-2 d-flex justify-content-center">
                                        <h3 class="mt-1">-</h3>
                                    </div>
                                    <div class="col-5">
                                        <input
                                            type="time"
                                            id="stopRange"
                                            min="00:00"
                                            max="24:00"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div id="gasAlarm" style="display: none;">
                                <h3 class="mt-3">Seleccionar sensor de gas</h3>
                                <div class="dropdown">
                                    <button
                                        class="btn btn-primary dropdown-toggle"
                                        data-bs-toggle="dropdown"
                                        type="button"
                                        id="dropdownGasButton"
                                        data-mdb-dropdown-init
                                        data-mdb-ripple-init
                                        aria-expanded="false"
                                    >
                                    </button>
                                    <ul class="dropdown-menu w-150" id="GasMenu" aria-labelledby="dropdownGasButton">
                                        <!-- Sensores de gas cargados din√°micamente -->
                                    </ul>
                                </div>
                            </div>
                            <div id="durationAlarm" style="display: none;">
                                <h3 class="mt-4">Duraci√≥n de alarma</h3>
                                <div class="row d-flex align-items-center">
                                    <input type="number" class="col-4" id="seconds" placeholder="00">
                                    <p class="col-4">segundos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="row actuador" id="actuador" style="display: none !important;">
                <div class="col-lg-5 d-flex justify-content-center align-items-center" id="leftCol-addtask">
                    <div>
                        <div class="d-flex" id="turnOnActuador">
                            <h3>Encender a la(s)</h3>
                            <input
                                type="time"
                                id="turnOnTimeActuador"
                                min="00:00"
                                max="24:00"
                                required
                            />
                        </div>
                        <br>
                        <div class="d-flex" id="turnOffActuador">
                            <h3>Apagar a la(s)</h3>
                            <input
                                type="time"
                                id="turnOffTimeActuador"
                                min="00:00"
                                max="24:00"
                                required
                            />
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 d-flex justify-content-center" id="rightCol-taskinfo">
                    <img src="images/Survey.png" alt="Image">
                </div>
            </div>

            <div class="col-lg-5 mt-3" id="btn-div" style="display: none !important;">
                <button id="task-button">Guardar</button>
            </div>
        </div>
    </div>
    <!-- End content -->

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <img src="images/logo.png" alt="KYROS logo" height="40px">
                        <h3 class="logo-h3">KYROS</h3>
                        <p>Manten el control sobre tu hogar</p>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Soporte</h2>
                        <ul>
                            <li><a href="helpcenter.html">Centro de ayuda</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Cont√°ctenos</h2>
                        <p>687-123-4567</p>
                        <p>kyros.iot@gmail.com</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <h3 class="copyright">&copy;2025 Instituto Tecnol√≥gico Superior de Guasave</h3>
            </div>
        </div>

    </footer>
    <!-- End footer -->

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="js/auth.js"></script>
    <script src="js/navbar.js"></script>

    <!-- SweetAlert Javascript -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        const dropdownItems = document.querySelectorAll('#tableMenu .dropdown-item');

        dropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownMenuButton');
                dropdownButton.textContent = item.textContent;
            });
        });
    </script>

    <script>
        //const API_URL = 'http://localhost:3000/api';
        let selectedDeviceId = null;

        function getParameterByName(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function eraseEnd(name){
            name = name.replace(/\&.*$/g, " ");
            return name;
        }

        function displayRoomName() {
            var roomname = getParameterByName('roomname');
            var devicename = getParameterByName('devicename');
            devicename = eraseEnd(devicename);
            console.log(devicename);
            console.log(roomname);
            document.getElementById("deviceRoute").innerHTML = devicename;
            document.getElementById("roomRoute").innerHTML = roomname;
        }

        displayRoomName();

        let selectedDeviceType = null;
        let selectedDeviceSubtype = null;

        // Funci√≥n para mostrar el formulario correcto seg√∫n el tipo de dispositivo
        function showFormForDeviceType(tipo) {
            const lightDiv = document.getElementById('start-light');
            const fanDiv = document.getElementById('start-fan');
            const alarmDiv = document.getElementById('alarm');
            const actuadorDiv = document.getElementById('actuador');
            const alarmLabel = document.getElementById('alarmLabel');

            // Ocultar todos
            if (lightDiv) lightDiv.style.display = 'none';
            if (fanDiv) fanDiv.style.display = 'none';
            if (alarmDiv) alarmDiv.style.display = 'none';
            if (actuadorDiv) actuadorDiv.style.display = 'none';

            // Mostrar el correcto seg√∫n el tipo
            if (tipo === 'luz') {
                if (lightDiv) lightDiv.style.display = 'flex';
            } else if (tipo === 'temperatura' || tipo === 'humedad') {
                if (fanDiv) fanDiv.style.display = 'flex';
            } else if (tipo === 'actuador') {
                if (actuadorDiv) actuadorDiv.style.display = 'flex';
            } else if (tipo === 'movimiento' || tipo === 'gas') {
                if (alarmDiv) {
                    alarmDiv.style.display = 'flex';
                    if (alarmLabel) {
                        alarmLabel.textContent = 'Activar a la(s)';
                    }
                }
            } else {
                // Por defecto, mostrar luz
                if (lightDiv) lightDiv.style.display = 'flex';
            }
        }

        // Cargar dispositivo espec√≠fico (viene desde la URL)
        async function loadDevices() {
            try {
                const deviceId = getParameterByName('deviceId');

                if (deviceId) {
                    // Cargar el dispositivo espec√≠fico
                    const deviceResponse = await fetchWithAuth(`${API_URL}/devices/${deviceId}`);
                    const deviceData = await deviceResponse.json();

                    if (deviceData.success) {
                        selectedDeviceId = deviceId;
                        selectedDeviceType = deviceData.data.tipo;
                        selectedDeviceSubtype = deviceData.data.subtipo || null;
                        console.log('üì± Dispositivo cargado - Tipo:', selectedDeviceType, 'Subtipo:', selectedDeviceSubtype);
                    } else {
                        swal("Error", "No se pudo cargar el dispositivo", "error");
                    }
                } else {
                    swal("Error", "No se especific√≥ un dispositivo", "error");
                }
            } catch (error) {
                console.error('Error al cargar dispositivos:', error);
                swal("Error", "Error al cargar los dispositivos", "error");
            }
        }

        // Cargar sensores de movimiento din√°micamente
        async function loadMovementSensors() {
            try {
                const response = await fetchWithAuth(`${API_URL}/devices?tipo=movimiento`);
                const data = await response.json();

                if (data.success) {
                    const dropdown = document.getElementById('MovementMenu');
                    const dropdownButton = document.getElementById('dropdownMovementButton');

                    dropdown.innerHTML = '';

                    if (data.data.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay sensores de movimiento</a></li>';
                        dropdownButton.textContent = 'Sin sensores';
                        return;
                    }

                    data.data.forEach(sensor => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item movement';
                        a.href = '#';
                        const habitacionNombre = sensor.habitacion?.nombre || 'Sin habitaci√≥n';
                        a.textContent = `${sensor.nombre} (${habitacionNombre})`;
                        a.dataset.sensorId = sensor._id;
                        a.onclick = (e) => {
                            e.preventDefault();
                            dropdownButton.textContent = sensor.nombre;
                            dropdownButton.dataset.sensorId = sensor._id;
                        };
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });

                    dropdownButton.textContent = 'Seleccionar sensor';
                }
            } catch (error) {
                console.error('Error al cargar sensores de movimiento:', error);
            }
        }

        // Cargar sensores de gas din√°micamente
        async function loadGasSensors() {
            try {
                const response = await fetchWithAuth(`${API_URL}/devices?tipo=gas`);
                const data = await response.json();

                if (data.success) {
                    const dropdown = document.getElementById('GasMenu');
                    const dropdownButton = document.getElementById('dropdownGasButton');

                    dropdown.innerHTML = '';

                    if (data.data.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay sensores de gas</a></li>';
                        dropdownButton.textContent = 'Sin sensores';
                        return;
                    }

                    data.data.forEach(sensor => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.className = 'dropdown-item gas';
                        a.href = '#';
                        const habitacionNombre = sensor.habitacion?.nombre || 'Sin habitaci√≥n';
                        a.textContent = `${sensor.nombre} (${habitacionNombre})`;
                        a.dataset.sensorId = sensor._id;
                        a.onclick = (e) => {
                            e.preventDefault();
                            dropdownButton.textContent = sensor.nombre;
                            dropdownButton.dataset.sensorId = sensor._id;
                        };
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });

                    dropdownButton.textContent = 'Seleccionar sensor';
                }
            } catch (error) {
                console.error('Error al cargar sensores de gas:', error);
            }
        }

        // Cargar sensores de temperatura din√°micamente
        async function loadTempSensors() {
            try {
                const response = await fetchWithAuth(`${API_URL}/devices?tipo=temperatura`);
                const data = await response.json();

                if (data.success) {
                    // Dropdown para encender
                    const dropdownOn = document.getElementById('TempOnMenu');
                    const dropdownButtonOn = document.getElementById('dropdownTempOnButton');

                    // Dropdown para apagar
                    const dropdownOff = document.getElementById('TempOffMenu');
                    const dropdownButtonOff = document.getElementById('dropdownTempOffButton');

                    dropdownOn.innerHTML = '';
                    dropdownOff.innerHTML = '';

                    if (data.data.length === 0) {
                        dropdownOn.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay sensores de temperatura</a></li>';
                        dropdownOff.innerHTML = '<li><a class="dropdown-item disabled" href="#">No hay sensores de temperatura</a></li>';
                        dropdownButtonOn.textContent = 'Sin sensores';
                        dropdownButtonOff.textContent = 'Sin sensores';
                        return;
                    }

                    data.data.forEach(sensor => {
                        const habitacionNombre = sensor.habitacion?.nombre || 'Sin habitaci√≥n';

                        // Crear opci√≥n para dropdown de ENCENDER
                        const liOn = document.createElement('li');
                        const aOn = document.createElement('a');
                        aOn.className = 'dropdown-item optionTempOn';
                        aOn.href = '#';
                        aOn.textContent = `${sensor.nombre} (${habitacionNombre})`;
                        aOn.dataset.sensorId = sensor._id.toString();
                        aOn.onclick = (e) => {
                            e.preventDefault();
                            dropdownButtonOn.textContent = sensor.nombre;
                            dropdownButtonOn.dataset.sensorId = sensor._id.toString();
                        };
                        liOn.appendChild(aOn);
                        dropdownOn.appendChild(liOn);

                        // Crear opci√≥n para dropdown de APAGAR
                        const liOff = document.createElement('li');
                        const aOff = document.createElement('a');
                        aOff.className = 'dropdown-item optionTempOff';
                        aOff.href = '#';
                        aOff.textContent = `${sensor.nombre} (${habitacionNombre})`;
                        aOff.dataset.sensorId = sensor._id.toString();
                        aOff.onclick = (e) => {
                            e.preventDefault();
                            dropdownButtonOff.textContent = sensor.nombre;
                            dropdownButtonOff.dataset.sensorId = sensor._id.toString();
                        };
                        liOff.appendChild(aOff);
                        dropdownOff.appendChild(liOff);
                    });

                    dropdownButtonOn.textContent = 'Seleccionar sensor';
                    dropdownButtonOff.textContent = 'Seleccionar sensor';
                }
            } catch (error) {
                console.error('Error al cargar sensores de temperatura:', error);
            }
        }

        // Cargar dispositivo y sensores cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            loadMovementSensors();
            loadGasSensors();
            loadTempSensors(); // Cargar sensores de temperatura
        });
    </script>

    <script>
        function sendRoom(){
            var roomname = document.getElementById("roomRoute").textContent;
            var roomId = getParameterByName('roomId');
            window.location.href = "devices.html?roomId="+roomId+"&roomname="+roomname;
        }
        function sendDevice(){
            var roomname = document.getElementById("roomRoute").textContent;
            var devicename = document.getElementById("deviceRoute").textContent;
            var roomId = getParameterByName('roomId');
            var deviceId = getParameterByName('deviceId');
            window.location.href = "deviceinfo.html?roomId="+roomId+"&roomname="+roomname+"&deviceId="+deviceId+"&devicename="+devicename;
        }

        // ‚úÖ Envolver todos los event listeners en DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {

        // Dropdown para opciones de encender abanico
        const dropdownOption = document.querySelectorAll('#optionMenu .option');

        dropdownOption.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOptionButton');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOn");
                let temp = document.getElementById("tempOn");
                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                    temp.classList.remove('d-flex');
                    temp.style.display="none";
                    document.getElementById("turnOnTemp").value = ""; // Asegurar que se limpie el input que no est√° en uso
                    document.getElementById("dropdownTempOnButton").textContent = "";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    document.getElementById("turnOnTime").value = ""; // Asegurar que se limpie el input que no est√° en uso
                    temp.classList.add('d-flex');
                    temp.style.display="flex";
                    // ‚úÖ Cargar sensores de temperatura autom√°ticamente
                    loadTempSensors();
                }
            });
        });
    
        // Dropdown de opciones para apagar abanico
        const dropdownOption2 = document.querySelectorAll('#option2Menu .option2');

        dropdownOption2.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption2Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOff");
                let temp = document.getElementById("tempOff");
                if(dropdownButton.innerText === "Apagar a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                    temp.classList.remove('d-flex');
                    temp.style.display="none";
                    document.getElementById("turnOffTemp").value = ""; // Asegurar que se limpie el input que no est√° en uso
                    document.getElementById("dropdownTempOffButton").textContent = "";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    temp.classList.add('d-flex');
                    temp.style.display="flex";
                    document.getElementById("turnOffTime").value = ""; // Asegurar que se limpie el input que no est√° en uso
                    // ‚úÖ Cargar sensores de temperatura autom√°ticamente
                    loadTempSensors();
                }
            });
        });
    
        // Dropdown de opciones para encender foco
        const dropdownOption3 = document.querySelectorAll('#option3Menu .option3');

        dropdownOption3.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption3Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOnLight");
                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    document.getElementById("turnOnTimeLight").value = ""; // Asegurar que se limpie el input que no est√° en uso
                }
            });
        });
    
        // Dropdown de opciones para apagar foco
        const dropdownOption4 = document.querySelectorAll('#option4Menu .option4');

        dropdownOption4.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption4Button');
                dropdownButton.textContent = item.textContent;

                let time = document.getElementById("timeOffLight");
                if(dropdownButton.innerText === "Apagar a una hora establecida"){
                    time.classList.add('d-flex');
                    time.style.display="flex";
                } else {
                    time.classList.remove('d-flex');
                    time.style.display="none";
                    document.getElementById("turnOffTimeLight").value = ""; // Asegurar que se limpie el input que no est√° en uso
                }
            });
        });

        // Dropdown de opciones para alarma/actuador
        const dropdownOption5 = document.querySelectorAll('#option5Menu .option5');

        dropdownOption5.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownOption5Button');
                dropdownButton.textContent = item.textContent;

                let timeDiv = document.getElementById("timeAlarm");
                let gas = document.getElementById("gasAlarm");
                let move = document.getElementById("movementAlarm");
                let dur = document.getElementById("durationAlarm");

                // Ocultar todos primero
                timeDiv.style.display = "none";
                gas.style.display = "none";
                move.style.display = "none";
                dur.style.display = "none";

                // Limpiar campos
                document.getElementById("turnOnTimeAlarm").value = "";
                document.getElementById("turnOffTimeAlarm").value = "";
                document.getElementById("dropdownGasButton").innerText = "";
                document.getElementById("dropdownMovementButton").innerText = "";
                document.getElementById("startRange").value = "";
                document.getElementById("stopRange").value = "";
                document.getElementById("seconds").value = "";

                if(dropdownButton.innerText === "Encender a una hora establecida"){
                    timeDiv.style.display = "block";
                } else if(dropdownButton.innerText === "Encender al detectar movimiento"){
                    move.style.display = "block";
                    dur.style.display = "block";
                } else if(dropdownButton.innerText === "Encender al sobrepasar los niveles de gas regulares"){
                    gas.style.display = "block";
                    dur.style.display = "block";
                }
            });
        });

        // Dropdown de opciones para seleccionar sensor de movimiento
        const dropdownMovement = document.querySelectorAll('#MovementMenu .movement');

        dropdownMovement.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownMovementButton');
                dropdownButton.textContent = item.textContent;
            });
        });

        // Dropdown de opciones para seleccionar sensor de gas
        const gasMovement = document.querySelectorAll('#GasMenu .gas');

        gasMovement.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownGasButton');
                dropdownButton.textContent = item.textContent;
            });
        });

        // Dropdown de opciones para seleccionar sensor de temp (encender)
        const tempOnMovement = document.querySelectorAll('#TempOnMenu .optionTempOn');

        tempOnMovement.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownTempOnButton');
                dropdownButton.textContent = item.textContent;
            });
        });

        // Dropdown de opciones para seleccionar sensor de temp (apagar)
        const tempOffMovement = document.querySelectorAll('#TempOffMenu .optionTempOff');

        tempOffMovement.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const dropdownButton = document.querySelector('#dropdownTempOffButton');
                dropdownButton.textContent = item.textContent;
            });
        });

        function nameClick(){
            let n = document.getElementById("name-input").value;
            if(n.trim()!==""){
                let ndiv = document.getElementById("name");
                ndiv.style.display = "none";

                // Determinar qu√© formulario mostrar basado en tipo y subtipo
                let formToShow = null;

                // Para actuadores, usar el subtipo para decidir el formulario
                if (selectedDeviceType === 'actuador') {
                    if (selectedDeviceSubtype === 'luz') {
                        formToShow = 'light';
                    } else if (selectedDeviceSubtype === 'ventilador') {
                        formToShow = 'fan';
                    } else if (selectedDeviceSubtype === 'alarma') {
                        formToShow = 'alarm';
                    } else {
                        // Actuador gen√©rico sin subtipo: mostrar todas las opciones (alarma)
                        formToShow = 'alarm';
                    }
                }
                // Para dispositivos que no son actuadores, usar el tipo directamente
                else if (selectedDeviceType === 'luz') {
                    formToShow = 'light';
                } else if (selectedDeviceType === 'temperatura' || selectedDeviceType === 'humedad') {
                    formToShow = 'fan';
                } else if (selectedDeviceType === 'movimiento' || selectedDeviceType === 'gas') {
                    formToShow = 'alarm';
                } else {
                    formToShow = 'light'; // Por defecto
                }

                // Mostrar el formulario correspondiente
                if (formToShow === 'light') {
                    let lightDiv = document.getElementById("start-light");
                    lightDiv.style.display = "flex";
                    lightDiv.classList.add('swing-in-bottom-bck');
                } else if (formToShow === 'fan') {
                    let fanDiv = document.getElementById("start-fan");
                    fanDiv.style.display = "flex";
                    fanDiv.classList.add('swing-in-bottom-bck');
                } else if (formToShow === 'alarm') {
                    let alarmDiv = document.getElementById("alarm");
                    let save = document.getElementById("btn-div");
                    alarmDiv.style.display = "flex";
                    save.style.display = "flex";
                    alarmDiv.classList.add('swing-in-bottom-bck');
                    save.classList.add('swing-in-bottom-bck');

                    // Solo cargar sensores si es tipo alarma o sensores de movimiento/gas
                    if (selectedDeviceSubtype === 'alarma' || selectedDeviceType === 'movimiento' || selectedDeviceType === 'gas') {
                        loadMovementSensors();
                        loadGasSensors();
                    }
                }
            } else {
                swal("Campo vac√≠o", "Favor de ingresar un nombre", "warning");
            }
        }

        function startFanClick(){
            let time = document.getElementById("turnOnTime").value;
            let temp = document.getElementById("turnOnTemp").value;
            let sensorId = document.getElementById("dropdownTempOnButton").dataset.sensorId;

            // Validar que se haya seleccionado AL MENOS una opci√≥n de encendido:
            // - Opci√≥n 1: Solo hora (time lleno, temp vac√≠o, sin sensor)
            // - Opci√≥n 2: Solo temperatura (temp lleno, sensor seleccionado, sin hora)
            if((time.trim()!=="" && temp.trim()==="" && !sensorId) ||
               (temp.trim()!=="" && sensorId && time.trim()==="")){
                let startdiv = document.getElementById("start-fan");
                let stopdiv = document.getElementById("stop-fan");
                let save = document.getElementById("btn-div");

                startdiv.style.display = "none";
                stopdiv.style.display = "flex";
                save.style.display = "flex"
                stopdiv.classList.add('swing-in-bottom-bck');
                save.classList.add('swing-in-bottom-bck');
            } else{
                swal("Campos vac√≠os", "Favor de seleccionar e ingresar una opci√≥n de encendido", "warning");
            }
        }

        function startLightClick(){
            let time = document.getElementById("turnOnTimeLight").value;
            let noLight = document.getElementById("dropdownOption3Button").textContent;
            if((time.trim()!=="") || (noLight==="Encender cuando no hay luz")){
                let startdiv = document.getElementById("start-light");
                let stopdiv = document.getElementById("stop-light");
                let save = document.getElementById("btn-div");

                startdiv.style.display = "none";
                stopdiv.style.display = "flex";
                save.style.display = "flex"
                stopdiv.classList.add('swing-in-bottom-bck');
                save.classList.add('swing-in-bottom-bck');
            } else{
                swal("Campos vac√≠os", "Favor de seleccionar una opci√≥n", "warning");
            }
        }

        }); // ‚úÖ Cierre de DOMContentLoaded

        // ============ FUNCIONES GLOBALES (llamadas desde onclick en HTML) ============
        // NOTA: Las funciones debajo ya est√°n definidas arriba dentro de DOMContentLoaded
        // Necesitamos sacarlas de ah√≠ y ponerlas aqu√≠ globalmente
    </script>

    <script>
        // Conectar bot√≥n de guardar tarea usando delegaci√≥n de eventos
        document.addEventListener('click', async (e) => {
            // Solo ejecutar si es el bot√≥n de Guardar (dentro de btn-div)
            const btnDiv = document.getElementById('btn-div');
            if (!e.target.matches('#btn-div #task-button')) {
                return;
            }

            e.preventDefault();

            const taskNameInput = document.querySelector('input[name="taskName"]');
            const taskName = taskNameInput.value.trim();

            if (!taskName) {
                swal("Campo vac√≠o", "Favor de ingresar el nombre de la tarea", "warning");
                return;
            }

            if (!selectedDeviceId) {
                swal("Campo vac√≠o", "Favor de seleccionar un dispositivo", "warning");
                return;
            }

            try {
                // Recopilar datos del formulario para automatizaci√≥n
                const taskData = {
                    nombre: taskName,
                    descripcion: '',
                    activa: true,
                    trigger: {
                        tipo: 'horario'
                    },
                    acciones: []
                };

                // Usar selectedDeviceType y selectedDeviceSubtype para determinar la l√≥gica
                console.log('üîç Guardando tarea para tipo:', selectedDeviceType, 'subtipo:', selectedDeviceSubtype);

                let accion = {
                    dispositivo: selectedDeviceId,
                    accion: 'toggle',
                    parametros: {},
                    orden: 0
                };

                // Determinar el tipo efectivo para la l√≥gica de guardado
                let tipoEfectivo = selectedDeviceType;
                if (selectedDeviceType === 'actuador' && selectedDeviceSubtype) {
                    tipoEfectivo = selectedDeviceSubtype;
                }

                // Si es actuador tipo alarma o actuador sin subtipo (usa formulario de alarma con 3 opciones)
                if (selectedDeviceType === 'actuador' && (selectedDeviceSubtype === 'alarma' || !selectedDeviceSubtype)) {
                    console.log('‚úÖ Tipo: ACTUADOR');
                    const opcionSeleccionada = document.getElementById("dropdownOption5Button").textContent;

                    if (!opcionSeleccionada || opcionSeleccionada.trim() === '') {
                        swal("Campo vac√≠o", "Favor de seleccionar una opci√≥n para encender", "warning");
                        return;
                    }

                    // Opci√≥n 1: Por hora
                    if (opcionSeleccionada === "Encender a una hora establecida") {
                        const turnOnTime = document.getElementById("turnOnTimeAlarm").value;
                        const turnOffTime = document.getElementById("turnOffTimeAlarm").value;

                        if (!turnOnTime) {
                            swal("Campo vac√≠o", "Favor de ingresar la hora de encendido", "warning");
                            return;
                        }

                        taskData.trigger.tipo = 'horario';
                        taskData.trigger.horario = {
                            dias: [0, 1, 2, 3, 4, 5, 6],
                            hora: turnOnTime
                        };

                        // ‚úÖ Agregar horaFin si existe hora de apagado
                        if (turnOffTime) {
                            taskData.trigger.horario.horaFin = turnOffTime;
                        }

                        accion.parametros = { horaApagar: turnOffTime || null };
                    }
                    // Opci√≥n 2: Por sensor de movimiento
                    else if (opcionSeleccionada === "Encender al detectar movimiento") {
                        const sensorId = document.getElementById("dropdownMovementButton").dataset.sensorId;
                        const startRange = document.getElementById("startRange").value;
                        const stopRange = document.getElementById("stopRange").value;
                        const duracion = document.getElementById("seconds").value;

                        if (!sensorId) {
                            swal("Campo vac√≠o", "Favor de seleccionar un sensor de movimiento", "warning");
                            return;
                        }

                        taskData.trigger.tipo = 'sensor';
                        taskData.trigger.sensor = {
                            dispositivo: sensorId,
                            tipoSensor: 'movimiento',
                            condicion: { operador: 'igual', valor: true }
                        };

                        accion.parametros = {
                            rangoInicio: startRange || null,
                            rangoFin: stopRange || null,
                            duracionSegundos: duracion ? parseInt(duracion) : null
                        };
                    }
                    // Opci√≥n 3: Por sensor de gas
                    else if (opcionSeleccionada === "Encender al sobrepasar los niveles de gas regulares") {
                        const sensorId = document.getElementById("dropdownGasButton").dataset.sensorId;
                        const duracion = document.getElementById("seconds").value;

                        if (!sensorId) {
                            swal("Campo vac√≠o", "Favor de seleccionar un sensor de gas", "warning");
                            return;
                        }

                        taskData.trigger.tipo = 'sensor';
                        taskData.trigger.sensor = {
                            dispositivo: sensorId,
                            tipoSensor: 'gas',
                            condicion: { operador: 'mayor', valor: 800 }
                        };

                        accion.parametros = {
                            duracionSegundos: duracion ? parseInt(duracion) : null
                        };
                    }

                    accion.accion = 'encender';
                    console.log('üì¶ Datos a guardar:', { trigger: taskData.trigger, parametros: accion.parametros });
                }
                // Si es luz o actuador tipo luz
                else if (tipoEfectivo === 'luz') {
                    console.log('‚úÖ Tipo: LUZ');
                    const turnOnTime = document.getElementById('turnOnTimeLight').value;
                    const turnOffTime = document.getElementById('turnOffTimeLight').value;
                    const lightOnSwitch = document.querySelector('#lightOnSwitch input[type="checkbox"]');
                    const lightOffSwitch = document.querySelector('#lightOffSwitch input[type="checkbox"]');

                    if (turnOnTime) {
                        taskData.trigger.horario = {
                            dias: [0, 1, 2, 3, 4, 5, 6],
                            hora: turnOnTime
                        };
                        // ‚úÖ Agregar horaFin si existe hora de apagado
                        if (turnOffTime) {
                            taskData.trigger.horario.horaFin = turnOffTime;
                        }
                    }

                    accion.accion = 'encender';
                    accion.parametros = {
                        encenderSinLuz: lightOnSwitch ? lightOnSwitch.checked : false,
                        apagarConLuz: lightOffSwitch ? lightOffSwitch.checked : false,
                        horaApagar: turnOffTime || null
                    };
                }
                // Si es temperatura/humedad o actuador tipo ventilador
                else if (tipoEfectivo === 'temperatura' || tipoEfectivo === 'humedad' || tipoEfectivo === 'ventilador') {
                    console.log('‚úÖ Tipo: TEMPERATURA/HUMEDAD');
                    const turnOnTime = document.getElementById('turnOnTime').value;
                    const turnOnTemp = document.getElementById('turnOnTemp').value;
                    const turnOnTempSensorId = document.getElementById('dropdownTempOnButton').dataset.sensorId;
                    const turnOffTime = document.getElementById('turnOffTime').value;
                    const turnOffTemp = document.getElementById('turnOffTemp').value;
                    const turnOffTempSensorId = document.getElementById('dropdownTempOffButton').dataset.sensorId;

                    console.log('üîç Valores le√≠dos del formulario:');
                    console.log('  - turnOnTime:', turnOnTime);
                    console.log('  - turnOnTemp:', turnOnTemp);
                    console.log('  - turnOnTempSensorId:', turnOnTempSensorId);
                    console.log('  - turnOffTime:', turnOffTime);
                    console.log('  - turnOffTemp:', turnOffTemp);
                    console.log('  - turnOffTempSensorId:', turnOffTempSensorId);

                    // Si se seleccion√≥ temperatura para encender
                    if (turnOnTemp && turnOnTempSensorId) {
                        // Validar que se haya seleccionado un sensor
                        if (!turnOnTempSensorId) {
                            swal("Campo vac√≠o", "Favor de seleccionar un sensor de temperatura", "warning");
                            return;
                        }

                        // Usar trigger de sensor en lugar de horario
                        taskData.trigger = {
                            tipo: 'sensor',
                            sensor: {
                                dispositivo: turnOnTempSensorId,
                                tipoSensor: 'temperatura',
                                condicion: { operador: 'mayor', valor: parseFloat(turnOnTemp) }
                            }
                        };
                        console.log('‚úÖ Creando trigger por sensor de temperatura');
                    }
                    // Si se seleccion√≥ hora para encender
                    else if (turnOnTime) {
                        taskData.trigger.horario = {
                            dias: [0, 1, 2, 3, 4, 5, 6],
                            hora: turnOnTime
                        };
                        // ‚úÖ Agregar horaFin si existe hora de apagado
                        if (turnOffTime) {
                            taskData.trigger.horario.horaFin = turnOffTime;
                        }
                        console.log('‚úÖ Creando trigger por horario');
                    }

                    accion.accion = 'encender';
                    accion.parametros = {
                        horaApagar: turnOffTime || null
                    };

                    // Agregar temperatura de apagado si se especific√≥
                    if (turnOffTemp) {
                        accion.parametros.temperaturaApagar = parseFloat(turnOffTemp);

                        // Guardar el sensor de apagado si se seleccion√≥
                        if (turnOffTempSensorId) {
                            accion.parametros.sensorTemperaturaApagar = turnOffTempSensorId;
                            console.log('‚úÖ Temperatura de apagado:', turnOffTemp, '¬∞C - Sensor:', turnOffTempSensorId);
                        } else {
                            console.log('‚úÖ Temperatura de apagado:', turnOffTemp, '¬∞C (sin sensor espec√≠fico)');
                        }
                    }

                    console.log('üì¶ Datos a guardar:', { trigger: taskData.trigger, parametros: accion.parametros });
                } else {
                    console.error('‚ùå Tipo de dispositivo no soportado:', tipoEfectivo);
                    swal("Error", "Tipo de dispositivo no soportado", "error");
                    return;
                }

                taskData.acciones.push(accion);

                console.log('üì¶ TaskData completo antes de enviar:', JSON.stringify(taskData, null, 2));

                // Crear la automatizaci√≥n
                const response = await fetchWithAuth(`${API_URL}/automatize`, {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });

                const data = await response.json();

                if (response.ok) {
                    await swal({title:"Tarea creada exitosamente", icon:"success",});
                    const roomId = getParameterByName('roomId');
                    const roomname = getParameterByName('roomname');
                    const deviceId = getParameterByName('deviceId');
                    const devicename = getParameterByName('devicename');

                    if (deviceId) {
                        window.location.href = `deviceinfo.html?roomId=${roomId}&roomname=${roomname}&deviceId=${deviceId}&devicename=${devicename}`;
                    } else {
                        window.location.href = 'automatize.html';
                    }
                } else {
                    swal("Error", "Error al crear la automatizaci√≥n", "error");
                }
            } catch (error) {
                console.error('Error:', error);
                swal("Error", "Error al conectar con el servidor", "error");
            }
        });
    </script>
</body>
</html>