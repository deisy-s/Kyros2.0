<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Seguridad - KYROS</title>
    <link rel="icon" href="images/logo.ico" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand me-auto" href="index.html">
                <img src="images/logo.png" height="40px" alt="KYROS logo">
                <h3 class="logoH">KYROS</h3>
            </a>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">KYROS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-center flex-grow-1 pe-3">
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" aria-current="page" href="index.html">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="rooms.html">Habitaciones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2 active" href="security.html">Seguridad</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="automatize.html">Automatizaci√≥n</a>
                        </li>
                    </ul>
                </div>
            </div>
            <a href="login.html" class="login-button">Iniciar sesi√≥n</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
    <!-- End navbar -->

    <!-- Content -->
    <div class="container" id="main-container-security">
        <div class="row">
            <!-- Breadcrumb -->
            <nav class="d-flex">
            <h6 class="mb-0" id="breadcrumb">
                <a href="index.html" class="text-reset">Inicio</a>
                <span>></span>
                <a href="#" class="text-reset">Seguridad</a>
            </h6>
            </nav>
            <!-- Breadcrumb -->
        </div>
        <div class="row">
            <div class="col-12">
                <h1 class="heading">Seguridad</h1>
            </div>
        </div>
        <div class="row" id="cameras-container">
            <!-- Las c√°maras se cargar√°n din√°micamente aqu√≠ -->
        </div>
    </div>
    <!-- End content -->

    <!-- Modal: C√°mara Creada (Instrucciones) -->
    <div class="modal fade" id="cameraCreatedModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">‚úÖ C√°mara Creada - Configuraci√≥n R√°pida</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success text-center">
                        <h6><strong>C√≥digo de Activaci√≥n</strong></h6>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control form-control-lg text-center fw-bold" id="newActivationCode" readonly style="font-size: 2rem; letter-spacing: 0.3em;">
                            <button class="btn btn-primary btn-lg" type="button" onclick="copyActivationCode()">Copiar</button>
                        </div>
                        <small class="text-muted">Ingresa este c√≥digo en el portal WiFi del ESP32-CAM</small>
                        <div class="mt-2">
                            <small class="text-muted">Expira en 24 horas</small>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>Sigue estos 3 simples pasos:</strong>
                    </div>

                    <ol class="fs-6">
                        <li class="mb-3">
                            <strong>Enciende tu ESP32-CAM</strong>
                            <p class="text-muted small mb-0">Conecta la c√°mara a la corriente. Crear√° una red WiFi llamada <code>"KYROS-CAM-SETUP"</code></p>
                        </li>
                        <li class="mb-3">
                            <strong>Con√©ctate desde tu celular</strong>
                            <p class="text-muted small mb-0">Ve a WiFi en tu celular ‚Üí Selecciona <code>"KYROS-CAM-SETUP"</code> (sin contrase√±a)<br>
                            Se abrir√° autom√°ticamente un portal web</p>
                        </li>
                        <li class="mb-3">
                            <strong>Completa el formulario</strong>
                            <p class="text-muted small mb-0">Ingresa en el portal:</p>
                            <ul class="small text-muted">
                                <li><strong>C√≥digo de Activaci√≥n:</strong> <span id="codePreview" class="badge bg-dark">------</span> (el de arriba)</li>
                                <li><strong>Nombre de tu WiFi:</strong> El WiFi de tu casa</li>
                                <li><strong>Contrase√±a WiFi:</strong> La contrase√±a de tu red</li>
                            </ul>
                        </li>
                    </ol>

                    <div class="alert alert-success">
                        <strong>¬°Y listo!</strong> El ESP32 se configurar√° autom√°ticamente y empezar√° a transmitir video. Lo ver√°s aparecer en esta p√°gina.
                    </div>

                    <div class="alert alert-warning">
                        <strong>Tiempo total:</strong> 1-2 minutos
                        <br>
                        <strong>Tip:</strong> Mant√©n este modal abierto para ver el c√≥digo f√°cilmente mientras configuras
                    </div>

                    <div class="text-center mt-3">
                        <a href="esp32-simulator.html" target="_blank" class="btn btn-outline-primary">
                            Probar con Simulador
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="copyActivationCode()">Copiar C√≥digo Nuevamente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <img src="images/logo.png" alt="KYROS logo" height="40px">
                        <h3 class="logo-h3">KYROS</h3>
                        <p>Manten el control sobre tu hogar</p>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Soporte</h2>
                        <ul>
                            <li><a href="helpcenter.html">Centro de ayuda</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="single-box">
                        <h2>Cont√°ctenos</h2>
                        <p>687-876-1208</p>
                        <p>kyros.iot@gmail.com</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <h3 class="copyright">&copy;2025 Instituto Tecnol√≥gico Superior de Guasave</h3>
            </div>
        </div>
    </footer>
    <!-- End footer -->

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <!-- SweetAlert Javascript -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!-- Auth utility -->
    <script src="js/auth.js"></script>
    <script src="js/navbar.js"></script>
    <script>
        requireAuth();
    </script>

    <!-- Security cameras functionality -->
    <script>
        async function loadCameras() {
        try {
            const response = await fetchWithAuth(`${API_URL}/cameras`);

            if (!response.ok) {
                throw new Error('Error al cargar c√°maras');
            }

            const data = await response.json();
            const cameras = data.data;

            const container = document.getElementById('cameras-container');
            container.innerHTML = '';

            if (cameras.length === 0) {
                container.innerHTML = '<p style="text-align: center; margin: 20px;">No hay c√°maras configuradas.</p>';
                return;
            }

            cameras.forEach(camera => {
                const cameraDiv = document.createElement('div');
                cameraDiv.className = 'col-md-6 col-sm-12';
                cameraDiv.id = 'cam-section';

                const roomName = camera.habitacion ? camera.habitacion.nombre : 'Sin habitaci√≥n';
                const isConnected = camera.estado.conectada;
                const isActive = camera.estado.activa; // Variable clave
                const streamUrl = camera.streamingConfig?.urlPrincipal || '';

                // --- L√≥gica de detecci√≥n ---
                const streamType = camera.streamingConfig?.tipo ? camera.streamingConfig.tipo.toLowerCase() : '';
                const streamUrlLower = streamUrl.toLowerCase();

                const isMjpegUrl = streamUrlLower.includes('mjpeg') || streamUrlLower.includes('mjpg');
                // ESP32-CAM: detectar por URL, tipo, o si es nueva sin vincular
                const isEsp32Cam = streamType === 'websocket' ||
                                   streamUrlLower.includes('/stream') ||
                                   streamUrlLower.includes(':81') ||
                                   (!streamUrl && !camera.linked); // Nueva ESP32-CAM sin configurar
                const isHttpUrl = streamUrlLower.startsWith('http://') || streamUrlLower.startsWith('https://');
                const isRtspUrl = streamUrlLower.startsWith('rtsp://');

                const canShowInBrowser = isEsp32Cam || streamType === 'mjpeg' || isMjpegUrl || (isHttpUrl && !isRtspUrl && streamType !== 'rtsp');

                cameraDiv.innerHTML = `
                    <div class="row">
                        <h3 class="col-8">${camera.nombre} - ${roomName}</h3>
                        <div class="col-4 d-flex justify-content-end">
                            <img class="col-2" src="images/Edit.png" style="cursor:pointer;" onclick="editCam('${camera._id}', '${camera.nombre}', '${camera.habitacion._id}', '${roomName}')">
                            <img class="col-2" src="images/Close.png" style="cursor:pointer;" onclick="deleteCam('${camera._id}', '${camera.nombre}')">
                        </div>
                    </div>

                    <div class="cam-view" style="background-color: #1a1a1a; min-height: 300px; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden; margin-bottom: 10px;">

                        ${!isActive ?
                            // CASO 1: C√ÅMARA INACTIVA (APAGADA POR USUARIO)
                            `<div style="color: #666; text-align: center;">
                                <h5 style="color: #888;">C√°mara desactivada</h5>
                                <small>Active el interruptor para ver el video</small>
                             </div>`
                            :
                            // CASO 2: C√ÅMARA ACTIVA -> Checar conexi√≥n
                            (isConnected ?
                                (isEsp32Cam ?
                                    // ESP32-CAM con WebSocket (streaming en vivo)
                                    `<div style="position: relative; width: 100%;">
                                        <canvas id="stream-canvas-${camera._id}"
                                                style="width: 100%; height: auto; max-height: 400px; object-fit: contain; display: block;">
                                        </canvas>
                                        <div id="stream-status-${camera._id}"
                                             style="position: absolute; top: 8px; left: 8px; color: #4CAF50; font-size: 11px; padding: 4px 8px; background: rgba(0,0,0,0.75); border-radius: 4px; font-weight: bold;">
                                            üî¥ Conectando...
                                        </div>
                                    </div>`
                                    :
                                    (canShowInBrowser ?
                                        // C√°mara tradicional con URL (MJPEG, HTTP)
                                        (streamUrl ?
                                            `<img src="${streamUrl}"
                                                  style="width: 100%; height: auto; max-height: 400px; object-fit: contain;"
                                                  onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                                  alt="Stream">
                                             <div style="color: #888; text-align: center; display: none;">
                                                <p>Error cargando stream</p>
                                             </div>`
                                            :
                                            // Sin URL configurada
                                            `<div style="color: #ffaa00; text-align: center; padding: 20px;">
                                                <h5 style="color: #ffaa00;">‚ö†Ô∏è URL no configurada</h5>
                                                <p style="font-size: 13px; color: #999;">Configure la URL del stream en edici√≥n</p>
                                            </div>`
                                        )
                                        :
                                        // RTSP u otro formato no soportado
                                        `<div style="color: #888; text-align: center;">
                                            <p>RTSP no soportado en web</p>
                                            <button class="btn btn-sm btn-primary" onclick="window.open('${streamUrl}')">Abrir externo</button>
                                        </div>`
                                    )
                                )
                                :
                                `<div style="color: #ff4444; font-weight: bold;">
                                    NO SIGNAL
                                    <p style="font-size: 12px; font-weight: normal; color: #888;">Verifique conexi√≥n el√©ctrica</p>
                                 </div>`
                            )
                        }
                    </div>

                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button id="active-btn-${camera._id}"
                                class="btn btn-sm ${isActive ? 'btn-success' : 'btn-secondary'}"
                                onclick="toggleCamera('${camera._id}', ${!isActive})">
                            ${isActive ? 'Activa' : 'Inactiva'}
                        </button>

                        <button id="rec-btn-${camera._id}"
                                class="btn btn-sm ${camera.estado.grabando ? 'btn-danger' : 'btn-outline-danger'}"
                                onclick="toggleRecording('${camera._id}', ${!camera.estado.grabando})">
                            ${camera.estado.grabando ? '‚è∫ Grabando' : '‚èπ Iniciar grabaci√≥n'}
                        </button>

                        <span id="status-text-${camera._id}"
                              style="color: ${isConnected ? '#4CAF50' : '#888'}; font-size: 12px;">
                            ${isConnected ? 'üü¢ Conectada' : '‚ö´ Desconectada'}
                        </span>
                    </div>
                `;

                container.appendChild(cameraDiv);
            });

            // Despu√©s de cargar todas las c√°maras, iniciar streams
            setTimeout(() => initializeStreams(cameras), 100);

        } catch (error) {
            console.error('Error:', error);
        }
    }

        // Objeto para guardar las conexiones WebSocket activas
        const activeStreams = {};

        function initializeStreams(cameras) {
            cameras.forEach(camera => {
                const streamType = camera.streamingConfig?.tipo ? camera.streamingConfig.tipo.toLowerCase() : '';
                const streamUrl = camera.streamingConfig?.urlPrincipal || '';
                const streamUrlLower = streamUrl.toLowerCase();

                const isEsp32Cam = streamType === 'websocket' ||
                                   streamUrlLower.includes('/stream') ||
                                   streamUrlLower.includes(':81') ||
                                   (!streamUrl && !camera.linked);

                const isActive = camera.estado.activa;
                const isConnected = camera.estado.conectada;

                // Solo conectar si es ESP32-CAM, est√° activa, conectada y NO tiene stream activo
                if (isEsp32Cam && isActive && isConnected && !activeStreams[camera._id]) {
                    connectCameraStream(camera._id);
                }
            });
        }

        function connectCameraStream(cameraId) {
            const canvas = document.getElementById(`stream-canvas-${cameraId}`);
            const statusDiv = document.getElementById(`stream-status-${cameraId}`);

            if (!canvas) {
                console.error('Canvas no encontrado para c√°mara:', cameraId);
                return;
            }

            // Si ya hay una conexi√≥n activa, verificar si sigue siendo v√°lida
            if (activeStreams[cameraId]) {
                const existingStream = activeStreams[cameraId];
                const existingWs = existingStream.ws;
                // Si la conexi√≥n est√° abierta y funcionando, no hacer nada
                if (existingWs && (existingWs.readyState === WebSocket.OPEN || existingWs.readyState === WebSocket.CONNECTING)) {
                    console.log('Stream ya conectado para c√°mara:', cameraId);
                    return;
                }
                // Si est√° cerrada o con error, limpiar
                delete activeStreams[cameraId];
            }

            const ctx = canvas.getContext('2d');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/camera`;

            const ws = new WebSocket(wsUrl);
            activeStreams[cameraId] = { ws, canvas, ctx };

            ws.onopen = () => {
                console.log('‚úÖ WebSocket conectado para c√°mara:', cameraId);
                // Suscribirse como viewer
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    cameraId: cameraId
                }));
                // El indicador se ocultar√° autom√°ticamente cuando llegue el primer frame
            };

            ws.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    // Es un frame de video (binario)
                    const img = new Image();
                    img.onload = () => {
                        // Obtener referencias actualizadas por si se regener√≥ el HTML
                        const currentCanvas = document.getElementById(`stream-canvas-${cameraId}`);
                        const currentStatusDiv = document.getElementById(`stream-status-${cameraId}`);

                        if (currentCanvas) {
                            const currentCtx = currentCanvas.getContext('2d');
                            // Ajustar tama√±o del canvas a la imagen
                            currentCanvas.width = img.width;
                            currentCanvas.height = img.height;
                            // Dibujar el frame
                            currentCtx.drawImage(img, 0, 0);

                            // Ocultar el indicador cuando llegue el primer frame
                            if (currentStatusDiv && currentStatusDiv.style.display !== 'none') {
                                currentStatusDiv.style.display = 'none';
                            }
                        }
                    };
                    img.src = URL.createObjectURL(event.data);
                }
            };

            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error para c√°mara', cameraId, error);
                const currentStatusDiv = document.getElementById(`stream-status-${cameraId}`);
                if (currentStatusDiv) {
                    currentStatusDiv.style.display = 'block';
                    currentStatusDiv.style.color = '#ff4444';
                    currentStatusDiv.textContent = 'üî¥ Error';
                }
            };

            ws.onclose = () => {
                console.log('‚ö´ WebSocket cerrado para c√°mara:', cameraId);
                const currentStatusDiv = document.getElementById(`stream-status-${cameraId}`);
                if (currentStatusDiv) {
                    currentStatusDiv.style.display = 'block';
                    currentStatusDiv.style.color = '#888';
                    currentStatusDiv.textContent = '‚ö´ Desconectado';
                }
                delete activeStreams[cameraId];
            };
        }

        // Limpiar conexiones cuando se salga de la p√°gina
        window.addEventListener('beforeunload', () => {
            Object.values(activeStreams).forEach(stream => {
                if (stream.ws) stream.ws.close();
            });
        });
        async function updateCameraStatus() {
            try {
                // Pedimos datos en silencio (sin borrar nada visualmente)
                const response = await fetchWithAuth(`${API_URL}/cameras`);
                if (!response.ok) return;
                
                const data = await response.json();
                const cameras = data.data;

                cameras.forEach(cam => {
                    // Buscamos los elementos por su ID √∫nico
                    const statusSpan = document.getElementById(`status-text-${cam._id}`);
                    const recBtn = document.getElementById(`rec-btn-${cam._id}`);
                    const activeBtn = document.getElementById(`active-btn-${cam._id}`);

                    // Si los elementos existen en el HTML, los actualizamos
                    if (statusSpan) {
                        const isConnected = cam.estado.conectada;
                        statusSpan.style.color = isConnected ? '#4CAF50' : '#888';
                        statusSpan.innerText = isConnected ? 'üü¢ Conectada' : '‚ö´ Desconectada';
                    }

                    if (recBtn) {
                        // Actualizar clase (color) y texto del bot√≥n de grabaci√≥n
                        recBtn.className = `btn btn-sm ${cam.estado.grabando ? 'btn-danger' : 'btn-outline-danger'}`;
                        recBtn.innerText = cam.estado.grabando ? '‚è∫ Grabando' : '‚èπ Iniciar grabaci√≥n';
                        // Actualizar el onclick para que tenga el nuevo estado inverso
                        recBtn.setAttribute('onclick', `toggleRecording('${cam._id}', ${!cam.estado.grabando})`);
                    }
                    
                    if (activeBtn) {
                        activeBtn.className = `btn btn-sm ${cam.estado.activa ? 'btn-success' : 'btn-secondary'}`;
                        activeBtn.innerText = cam.estado.activa ? 'Activa' : 'Inactiva';
                        activeBtn.setAttribute('onclick', `toggleCamera('${cam._id}', ${!cam.estado.activa})`);
                    }
                });

            } catch (error) {
                console.error("Error actualizando estados en segundo plano", error);
            }
        }
        async function toggleCamera(cameraId, newState) {
            try {
                const response = await fetchWithAuth(`${API_URL}/cameras/${cameraId}/toggle`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    loadCameras(); // Recargar c√°maras
                } else {
                    swal("Error", "Error al cambiar el estado de la c√°mara", "error");
                }
            } catch (error) {
                console.error('Error:', error);
                swal("Error", "Error al conectar con el servidor", "error");
            }
        }

        async function toggleRecording(cameraId, newState) {
            try {
                const response = await fetchWithAuth(`${API_URL}/cameras/${cameraId}/recording`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    loadCameras(); // Recargar c√°maras
                } else {
                    swal("Error", "Error al cambiar la grabaci√≥n", "error");
                }
            } catch (error) {
                console.error('Error:', error);
                swal("Error", "Error al conectar con el servidor", "error");
            }
        }

        async function editCam(cameraId, cameraName, roomId, roomName) {
            // Redirigir a la p√°gina de edici√≥n de c√°mara
            window.location.href = `cameraedit.html?cameraId=${cameraId}`;
        }

        async function deleteCam(cameraId, cameraName) {
            const willDelete = await swal({
                title: "¬øEst√° seguro?",
                text: `Se eliminar√° la c√°mara "${cameraName}"`,
                icon: "warning",
                buttons: true,
                dangerMode: true,
            });

            if (!willDelete) {
                return;
            }

            try {
                const response = await fetchWithAuth(`${API_URL}/cameras/${cameraId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    swal({title:"C√°mara eliminada exitosamente", icon:"success"});
                    loadCameras(); // Recargar c√°maras
                } else {
                    swal("Error", data.error || "Error al eliminar la c√°mara", "error");
                }
            } catch (error) {
                console.error('Error:', error);
                swal("Error", "Error al conectar con el servidor", "error");
            }
        }

        // Copiar c√≥digo de activaci√≥n al portapapeles
        function copyActivationCode() {
            const activationCode = document.getElementById('newActivationCode').value;
            navigator.clipboard.writeText(activationCode).then(() => {
                swal("¬°Copiado!", `C√≥digo ${activationCode} copiado al portapapeles`, "success");
            }).catch(err => {
                swal("Error", "No se pudo copiar el c√≥digo", "error");
            });
        }

        // Cargar c√°maras al iniciar
        loadCameras();

        // Recargar cada 5 segundos para actualizar estado
        setInterval(loadCameras, 5000);
    </script>
</body>
</html>